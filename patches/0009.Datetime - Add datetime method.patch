From 90e1419045bdc0f1e3bb2af34928db17394eef12 Mon Sep 17 00:00:00 2001
From: Himmelt <master@void-3.cn>
Date: Wed, 30 Apr 2025 17:06:07 +0800
Subject: [PATCH] Add datetime method

---
 CPP/7zip/UI/GUI/CompressDialog.cpp | 38 ++++++++++++++++++++++++++++++
 CPP/7zip/UI/GUI/CompressDialog.h   |  2 ++
 2 files changed, 40 insertions(+)

diff --git a/CPP/7zip/UI/GUI/CompressDialog.cpp b/CPP/7zip/UI/GUI/CompressDialog.cpp
index 161a957e..a92087e6 100644
--- a/CPP/7zip/UI/GUI/CompressDialog.cpp
+++ b/CPP/7zip/UI/GUI/CompressDialog.cpp
@@ -606,6 +606,13 @@ bool CCompressDialog::OnButtonClicked(unsigned buttonID, HWND buttonHWND)
       SetMemoryUsage();
       return true;
     }
+    case IDX_ADD_DATETIME_TO_FILENAME:
+    {
+      SetMethod(GetMethodID());
+      OnButtonAddDatetime();
+      SetMemoryUsage();
+      return true;
+    }
     case IDX_PASSWORD_SHOW:
     {
       UpdatePasswordControl();
@@ -765,6 +772,12 @@ bool CCompressDialog::IsSFX()
       && IsButtonCheckedBool(IDX_COMPRESS_SFX);
 }
 
+bool CCompressDialog::IsAddDatetime()
+{
+  return IsWindowEnabled(GetItem(IDX_ADD_DATETIME_TO_FILENAME))
+      && IsButtonCheckedBool(IDX_ADD_DATETIME_TO_FILENAME);
+}
+
 static int GetExtDotPos(const UString &s)
 {
   const int dotPos = s.ReverseFind_Dot();
@@ -802,6 +815,31 @@ void CCompressDialog::OnButtonSFX()
   // CheckVolumeEnable();
 }
 
+void CCompressDialog::OnButtonAddDatetime(){
+  UString fileName;
+  m_ArchivePath.GetText(fileName);
+  const int dotPos = GetExtDotPos(fileName);
+  if (IsAddDatetime())
+  {
+    if (dotPos >= 0)
+      fileName.DeleteFrom(dotPos);
+    fileName += kExeExt;
+    m_ArchivePath.SetText(fileName);
+  }
+  else
+  {
+    if (dotPos >= 0)
+    {
+      const UString ext = fileName.Ptr(dotPos);
+      if (ext.IsEqualTo_Ascii_NoCase(kExeExt))
+      {
+        fileName.DeleteFrom(dotPos);
+        m_ArchivePath.SetText(fileName);
+      }
+    }
+    SetArchiveName2(false); // it's for OnInit
+  }
+}
 
 bool CCompressDialog::GetFinalPath_Smart(UString &resPath) const
 {
diff --git a/CPP/7zip/UI/GUI/CompressDialog.h b/CPP/7zip/UI/GUI/CompressDialog.h
index e0f3aa53..2150b6d8 100644
--- a/CPP/7zip/UI/GUI/CompressDialog.h
+++ b/CPP/7zip/UI/GUI/CompressDialog.h
@@ -353,7 +353,9 @@ class CCompressDialog: public NWindows::NControl::CModalDialog
 
   void OnButtonSetArchive();
   bool IsSFX();
+  bool IsAddDatetime();
   void OnButtonSFX();
+  void OnButtonAddDatetime();
 
   virtual bool OnInit() Z7_override;
   virtual bool OnMessage(UINT message, WPARAM wParam, LPARAM lParam) Z7_override;
