From ea6457b4ba78a863837cd8afe63f091d55f5abfc Mon Sep 17 00:00:00 2001
From: Nobody <36154203+PopuriAO29@users.noreply.github.com>
Date: Sun, 14 Jan 2024 03:40:09 +0000
Subject: [PATCH]: add-smart-extract-context-menu-option

---
diff --git a/CPP/7zip/UI/Explorer/ContextMenu.cpp b/CPP/7zip/UI/Explorer/ContextMenu.cpp
index 3dd19850..fbecb700 100644
--- a/CPP/7zip/UI/Explorer/ContextMenu.cpp
+++ b/CPP/7zip/UI/Explorer/ContextMenu.cpp
@@ -274,6 +274,7 @@ static const CContextMenuCommand g_Commands[] =
   CMD_REC( kExtract,     "Extract",     IDS_CONTEXT_EXTRACT),
   CMD_REC( kExtractHere, "ExtractHere", IDS_CONTEXT_EXTRACT_HERE),
   CMD_REC( kExtractTo,   "ExtractTo",   IDS_CONTEXT_EXTRACT_TO),
+  CMD_REC( kExtractSmart,        "ExtractSmart",        IDS_CONTEXT_EXTRACT_SMART),
   CMD_REC( kTest,        "Test",        IDS_CONTEXT_TEST),
   CMD_REC( kCompress,           "Compress",           IDS_CONTEXT_COMPRESS),
   CMD_REC( kCompressEmail,      "CompressEmail",      IDS_CONTEXT_COMPRESS_EMAIL),
@@ -902,6 +902,26 @@ Z7_COMWF_B CZipContextMenu::QueryContextMenu(HMENU hMenu, UINT indexMenu,
           Set_UserString_in_LastCommand(label);
           MyInsertMenu(popupMenu, subIndex++, currentCommandID++, label, bitmap);
        }
+ 
+        if ((contextMenuFlags & NContextMenuFlags::kExtractSmart) != 0)
+        {
+          if (_fileNames.Size() == 1)
+          {
+            // Extract Here Smart
+            CCommandMapItem cmi;
+            cmi.Folder = baseFolder;
+            AddCommand(kExtractSmart, mainString, cmi);
+            MyInsertMenu(popupMenu, subIndex++, currentCommandID++, mainString, bitmap);
+          }
+          else
+          {
+            // Extract To Smart
+            CCommandMapItem cmi;
+            AddCommand(kExtractSmart, mainString, cmi);
+            cmi.Folder = baseFolder + specFolder;
+            MyInsertMenu(popupMenu, subIndex++, currentCommandID++, mainString, bitmap);
+          }
+        }
       }
 
       if ((contextMenuFlags & NContextMenuFlags::kTest) != 0)
@@ -1288,6 +1309,7 @@ HRESULT CZipContextMenu::InvokeCommandCommon(const CCommandMapItem &cmi)
       case kExtract:
       case kExtractHere:
       case kExtractTo:
+      case kExtractSmart:
       {
         if (_attribs.FirstDirIndex != -1)
         {
diff --git a/CPP/7zip/UI/Explorer/ContextMenu.h b/CPP/7zip/UI/Explorer/ContextMenu.h
index 6f24c06a..668833f3 100644
--- a/CPP/7zip/UI/Explorer/ContextMenu.h
+++ b/CPP/7zip/UI/Explorer/ContextMenu.h
@@ -78,6 +78,7 @@ public:
     kExtract,
     kExtractHere,
     kExtractTo,
+    kExtractSmart,
     kTest,
     kCompress,
     kCompressEmail,
diff --git a/CPP/7zip/UI/Explorer/ContextMenuFlags.h b/CPP/7zip/UI/Explorer/ContextMenuFlags.h
index 50c177e9..86653319 100644
--- a/CPP/7zip/UI/Explorer/ContextMenuFlags.h
+++ b/CPP/7zip/UI/Explorer/ContextMenuFlags.h
@@ -8,18 +8,19 @@ namespace NContextMenuFlags
   const UInt32 kExtract = 1 << 0;
   const UInt32 kExtractHere = 1 << 1;
   const UInt32 kExtractTo = 1 << 2;
+  const UInt32 kExtractSmart = 1 << 3;
 
-  const UInt32 kTest = 1 << 4;
-  const UInt32 kOpen = 1 << 5;
-  const UInt32 kOpenAs = 1 << 6;
+  const UInt32 kTest = 1 << 5;
+  const UInt32 kOpen = 1 << 6;
+  const UInt32 kOpenAs = 1 << 7;
 
-  const UInt32 kCompress = 1 << 8;
-  const UInt32 kCompressTo7z = 1 << 9;
-  const UInt32 kCompressEmail = 1 << 10;
-  const UInt32 kCompressTo7zEmail = 1 << 11;
-  const UInt32 kCompressToZip = 1 << 12;
-  const UInt32 kCompressToZipWithDate = 1 << 13;
-  const UInt32 kCompressToZipEmail = 1 << 14;
+  const UInt32 kCompress = 1 << 9;
+  const UInt32 kCompressTo7z = 1 << 10;
+  const UInt32 kCompressEmail = 1 << 11;
+  const UInt32 kCompressTo7zEmail = 1 << 12;
+  const UInt32 kCompressToZip = 1 << 13;
+  const UInt32 kCompressToZipWithDate = 1 << 14;
+  const UInt32 kCompressToZipEmail = 1 << 15;
 
   const UInt32 kCRC_Cascaded = (UInt32)1 << 30;
   const UInt32 kCRC = (UInt32)1 << 31;
diff --git a/CPP/7zip/UI/Explorer/resource.h b/CPP/7zip/UI/Explorer/resource.h
index bbb28b16..88ff30b0 100644
--- a/CPP/7zip/UI/Explorer/resource.h
+++ b/CPP/7zip/UI/Explorer/resource.h
@@ -6,9 +6,10 @@
 #define IDS_CONTEXT_TEST                2325
 #define IDS_CONTEXT_EXTRACT_HERE        2326
 #define IDS_CONTEXT_EXTRACT_TO          2327
-#define IDS_CONTEXT_COMPRESS_TO         2328
-#define IDS_CONTEXT_COMPRESS_EMAIL      2329
-#define IDS_CONTEXT_COMPRESS_TO_EMAIL   2330
+#define IDS_CONTEXT_EXTRACT_SMART       2328
+#define IDS_CONTEXT_COMPRESS_TO         2329
+#define IDS_CONTEXT_COMPRESS_EMAIL      2330
+#define IDS_CONTEXT_COMPRESS_TO_EMAIL   2331
 
 #define IDS_SELECT_FILES                3015
 
diff --git a/CPP/7zip/UI/Explorer/resource2.rc b/CPP/7zip/UI/Explorer/resource2.rc
index de34824b..c5cc0524 100644
--- a/CPP/7zip/UI/Explorer/resource2.rc
+++ b/CPP/7zip/UI/Explorer/resource2.rc
@@ -10,6 +10,7 @@ BEGIN
   IDS_CONTEXT_TEST        "Test archive"
   IDS_CONTEXT_EXTRACT_HERE "Extract Here"
   IDS_CONTEXT_EXTRACT_TO  "Extract to {0}"
+  IDS_CONTEXT_EXTRACT_SMART "Smart extract"
   IDS_CONTEXT_COMPRESS_TO "Add to {0}"
   IDS_CONTEXT_COMPRESS_EMAIL "Compress and email..."
   IDS_CONTEXT_COMPRESS_TO_EMAIL "Compress to {0} and email"
diff --git a/CPP/7zip/UI/FileManager/MenuPage.cpp b/CPP/7zip/UI/FileManager/MenuPage.cpp
index af8a4c48..09e18d2f 100644
--- a/CPP/7zip/UI/FileManager/MenuPage.cpp
+++ b/CPP/7zip/UI/FileManager/MenuPage.cpp
@@ -55,6 +55,7 @@ static const CContextMenuItem kMenuItems[] =
   { IDS_CONTEXT_EXTRACT, kExtract },
   { IDS_CONTEXT_EXTRACT_HERE, kExtractHere },
   { IDS_CONTEXT_EXTRACT_TO, kExtractTo },
+  { IDS_CONTEXT_EXTRACT_SMART, kExtractSmart },
 
   { IDS_CONTEXT_TEST, kTest },
 
