From 451496d042d798b313ed4e0b7fc160e1c1613502 Mon Sep 17 00:00:00 2001
From: ironyman <ironyman13@gmail.com>
Date: Thu, 2 May 2024 21:39:04 -0700
Subject: [PATCH] Select the file when entering from address bar

---
 CPP/7zip/UI/FileManager/App.h                 |  2 +-
 CPP/7zip/UI/FileManager/MultiPanel.cpp        |  8 ++-
 CPP/7zip/UI/FileManager/Panel.h               |  4 +-
 CPP/7zip/UI/FileManager/PanelFolderChange.cpp | 54 +++++++++++++++++--
 CPP/7zip/UI/FileManager/PanelItems.cpp        | 10 +---
 5 files changed, 63 insertions(+), 15 deletions(-)

diff --git a/CPP/7zip/UI/FileManager/App.h b/CPP/7zip/UI/FileManager/App.h
index 0f0c495..afd15fa 100644
--- a/CPP/7zip/UI/FileManager/App.h
+++ b/CPP/7zip/UI/FileManager/App.h
@@ -58,7 +58,7 @@ class CPanelCallbackImp Z7_final: public CPanelCallback
   virtual HRESULT OnRefreshList(bool& shouldReturn) Z7_override;
   virtual HRESULT OnBind(bool& shouldReturn) Z7_override;
   virtual HRESULT OnSelectedItemChanged() Z7_override;
-  virtual HRESULT OnOpenFolder(std::optional<std::reference_wrapper<bool>> shouldReturn = std::nullopt) Z7_override;
+  virtual HRESULT OnOpenFolder(std::optional<std::reference_wrapper<bool>> shouldReturn = std::nullopt, std::optional<UString> path = std::nullopt) Z7_override;
   virtual HRESULT OnOpenParentFolder() Z7_override;
   virtual UString OnSetComboText(UString const& text) Z7_override;
   virtual bool IsMultiPanelMode() Z7_override;
diff --git a/CPP/7zip/UI/FileManager/MultiPanel.cpp b/CPP/7zip/UI/FileManager/MultiPanel.cpp
index 7fffc06..c6e4874 100644
--- a/CPP/7zip/UI/FileManager/MultiPanel.cpp
+++ b/CPP/7zip/UI/FileManager/MultiPanel.cpp
@@ -186,7 +186,7 @@ HRESULT CPanelCallbackImp::OnSelectedItemChanged()
   return S_OK;
 }
 
-HRESULT CPanelCallbackImp::OnOpenFolder(std::optional<std::reference_wrapper<bool>> shouldReturn)
+HRESULT CPanelCallbackImp::OnOpenFolder(std::optional<std::reference_wrapper<bool>> shouldReturn, std::optional<UString> path)
 {
   if (_app->MultiPanelMode == 0)
   {
@@ -216,6 +216,12 @@ HRESULT CPanelCallbackImp::OnOpenFolder(std::optional<std::reference_wrapper<boo
   _app->Panels[1]._listView.SetItemState_Selected(0, true);
   _app->Panels[1].SetFocusToList();
 
+  if (path.has_value())
+  {
+    auto file = path.value().GetFileName();
+    file.TrimRight();
+    _app->Panels[1].FindNextItem(file, 0);
+  }
   return S_OK;
 }
 
diff --git a/CPP/7zip/UI/FileManager/Panel.h b/CPP/7zip/UI/FileManager/Panel.h
index 3872377..58970aa 100644
--- a/CPP/7zip/UI/FileManager/Panel.h
+++ b/CPP/7zip/UI/FileManager/Panel.h
@@ -85,7 +85,7 @@ DECLARE_INTERFACE(CPanelCallback)
   virtual HRESULT OnRefreshList(bool& shouldReturn) = 0;
   virtual HRESULT OnBind(bool& shouldReturn) = 0;
   virtual HRESULT OnSelectedItemChanged() = 0;
-  virtual HRESULT OnOpenFolder(std::optional<std::reference_wrapper<bool>> shouldReturn = std::nullopt) = 0;
+  virtual HRESULT OnOpenFolder(std::optional<std::reference_wrapper<bool>> shouldReturn = std::nullopt, std::optional<UString> path = std::nullopt) = 0;
   virtual HRESULT OnOpenParentFolder() = 0;
   virtual UString OnSetComboText(UString const& text) = 0;
   virtual bool IsMultiPanelMode() = 0;
@@ -341,6 +341,8 @@ class CPanel Z7_final: public NWindows::NControl::CWindow2
   #ifndef UNDER_CE
 
   LRESULT OnNotifyComboBoxEnter(const UString &s);
+  LRESULT OnNotifyComboBoxEnterShowInDirectory(const UString &s);
+
   bool OnNotifyComboBoxEndEdit(PNMCBEENDEDITW info, LRESULT &result);
   #ifndef _UNICODE
   bool OnNotifyComboBoxEndEdit(PNMCBEENDEDIT info, LRESULT &result);
diff --git a/CPP/7zip/UI/FileManager/PanelFolderChange.cpp b/CPP/7zip/UI/FileManager/PanelFolderChange.cpp
index 8b8fab5..b16e178 100644
--- a/CPP/7zip/UI/FileManager/PanelFolderChange.cpp
+++ b/CPP/7zip/UI/FileManager/PanelFolderChange.cpp
@@ -25,6 +25,8 @@
 #include "resource.h"
 #include "Path.h"
 
+#include <shlwapi.h>
+
 using namespace NWindows;
 using namespace NFile;
 using namespace NFind;
@@ -444,10 +446,56 @@ void CPanel::LoadFullPathAndShow()
 LRESULT CPanel::OnNotifyComboBoxEnter(const UString &s)
 {
   auto path = ExpandEnvironmentStringsWrapper(std::wstring(s == L"~" ? L"%USERPROFILE%" : (const wchar_t *)s));
-  if (path && BindToPathAndRefresh(GetUnicodeString(UString((*path).data()))) == S_OK)
+  if (!path)
+  {
+    return FALSE;
+  }
+
+  if (BindToPathAndRefresh(GetUnicodeString(UString((*path).data()))) == S_OK)
+  {
+    bool shouldReturn;
+    _panelCallback->OnOpenFolder(shouldReturn, UString((*path).data()));
+    if (shouldReturn)
+    {
+      return TRUE;
+    }
+
+    PostMsg(kSetFocusToListView);
+    return TRUE;
+  }
+  return FALSE;
+}
+
+template<typename T, typename F>
+auto map_optional(std::optional<T>& opt, F func) {
+    if (opt.has_value()) {
+        return std::optional<std::invoke_result_t<F, T>>(func(opt.value()));
+    } else {
+        return std::optional<std::invoke_result_t<F, T>>();
+    }
+}
+
+LRESULT CPanel::OnNotifyComboBoxEnterShowInDirectory(const UString &s)
+{
+  auto pathStdStr = ExpandEnvironmentStringsWrapper(std::wstring(s == L"~" ? L"%USERPROFILE%" : (const wchar_t *)s));
+  auto path = map_optional(pathStdStr, [](std::wstring s) { return UString(s.data()); });
+  if (!path)
+  {
+    return FALSE;
+  }
+
+  auto dir = path->GetDirectory();
+  if (!PathIsDirectory(dir))
+  {
+    dir = dir.GetDirectory();
+  }
+  auto name = path->GetFileName();
+  name.TrimRight();
+
+  if (BindToPathAndRefresh(GetUnicodeString(dir)) == S_OK)
   {
     bool shouldReturn;
-    _panelCallback->OnOpenFolder(shouldReturn);
+    _panelCallback->OnOpenFolder(shouldReturn, *path);
     if (shouldReturn)
     {
       return TRUE;
@@ -482,7 +530,7 @@ bool CPanel::OnNotifyComboBoxEndEdit(PNMCBEENDEDITW info, LRESULT &result)
     // When we use Edit control and press Enter.
     UString s;
     _headerComboBox.GetText(s);
-    result = OnNotifyComboBoxEnter(s);
+    result = OnNotifyComboBoxEnterShowInDirectory(s);
     return true;
   }
   return false;
diff --git a/CPP/7zip/UI/FileManager/PanelItems.cpp b/CPP/7zip/UI/FileManager/PanelItems.cpp
index 87c349b..c2d18a9 100644
--- a/CPP/7zip/UI/FileManager/PanelItems.cpp
+++ b/CPP/7zip/UI/FileManager/PanelItems.cpp
@@ -1463,18 +1463,10 @@ void CPanel::FindFzf()
     {
       SetForegroundWindow(g_HWND);
       path.Insert(0, cwd.Ptr());
-      auto dir = path;
-      if (!PathIsDirectory(dir))
-      {
-        dir = dir.GetDirectory();
-      }
-      auto name = path.GetFileName();
-      name.TrimRight();
       // Actually don't even need the SendMessage(..., kOpenPath, ...)
       if (IsGUIThread(TRUE))
       {
-        that->OnNotifyComboBoxEnter(path);
-        that->FindNextItem(name, 0);
+        that->OnNotifyComboBoxEnterShowInDirectory(path);
       }
       else
       {
