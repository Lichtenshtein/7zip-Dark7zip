From c6e7470c070b869706abcf28174847aec0760ecf Mon Sep 17 00:00:00 2001
From: ironyman <ironyman13@gmail.com>
Date: Tue, 26 Dec 2023 04:15:40 -0800
Subject: [PATCH] Fix drag and drop from explorer so move works

---
 CPP/7zip/UI/FileManager/PanelDrag.cpp |  4 +++-
 CPP/Windows/Clipboard.cpp             | 22 +++++++++-------------
 2 files changed, 12 insertions(+), 14 deletions(-)

diff --git a/CPP/7zip/UI/FileManager/PanelDrag.cpp b/CPP/7zip/UI/FileManager/PanelDrag.cpp
index 576fe7a..1c24406 100644
--- a/CPP/7zip/UI/FileManager/PanelDrag.cpp
+++ b/CPP/7zip/UI/FileManager/PanelDrag.cpp
@@ -2699,7 +2699,9 @@ Z7_COMWF_B CDropTarget::Drop(IDataObject *dataObject, DWORD keyState,
         if (target.FolderType == k_FolderType_Fs)
         {
           CCopyToOptions options;
-          options.moveMode = moveMode;
+          // if (cmd == NDragMenu::k_AddToArc) earlier resets cmdEffect to copy for some reason
+          // but this panel is not an archive.
+          options.moveMode = (GetEffect(keyState, pt, 7) == DROPEFFECT_MOVE);
           options.folder = GetFolderPath(m_Panel->_folder);
           options.showErrorMessages = true;
           options.NeedRegistryZone = false;
diff --git a/CPP/Windows/Clipboard.cpp b/CPP/Windows/Clipboard.cpp
index 8fef4c4..2f61d35 100644
--- a/CPP/Windows/Clipboard.cpp
+++ b/CPP/Windows/Clipboard.cpp
@@ -230,7 +230,7 @@ HRESULT __stdcall DataObject::GetCanonicalFormatEtc(FORMATETC* /*pFormatEtc*/, F
 HRESULT __stdcall DataObject::SetData(FORMATETC* pFormatEtc, STGMEDIUM* pMedium, BOOL fRelease)
 {
   assert(fRelease == TRUE); //  return E_NOTIMPL;
-  // https://en.cppreference.com/w/cpp/language/aggregate_initialization
+  // https://en.cppreference.com/w/cpp/language/aggregate_initialization#Designated_initializers
   fmtetcs.emplace_back(FORMATETC{
     .cfFormat = pFormatEtc->cfFormat,
     .ptd = NULL,
@@ -300,7 +300,7 @@ void ClipboardSetFiles(HWND owner, const std::vector<std::wstring>& filePaths, D
   NCOM::CStgMedium medium;
   CMyComPtr<IDataObject> clipboardObject;
 
-  // HRESULT hr = S_OK;
+  HRESULT hr = S_OK;
   // hr = OleGetClipboard(&clipboardObject);
 
   // if (FAILED(hr))
@@ -349,10 +349,6 @@ void ClipboardSetFiles(HWND owner, const std::vector<std::wstring>& filePaths, D
   {
     int ret = wcsncpy_s(fileBufferPos, fileBufferSize - (fileBufferPos - fileBuffer),
               filePath.c_str(), filePath.length());
-    if (ret != 0)
-    {
-      MessageBox(0, L"HI", L"HI", 0);
-    }
     fileBufferPos += filePath.length() + 1;
   }
   // __debugbreak();
@@ -360,7 +356,6 @@ void ClipboardSetFiles(HWND owner, const std::vector<std::wstring>& filePaths, D
   GlobalUnlock(medium.hGlobal);
 
   clipboardObject = new DataObject(CF_HDROP, medium.hGlobal);
-
   // NShell::DataObject_SetData_HGLOBAL(clipboardObject.get(), CF_HDROP, medium);
 
   medium.hGlobal = NULL;
@@ -382,12 +377,13 @@ void ClipboardSetFiles(HWND owner, const std::vector<std::wstring>& filePaths, D
   GlobalUnlock(medium.hGlobal);
   pdwEffect = NULL;
 
-  // hr = NShell::DataObject_SetData_HGLOBAL(clipboardObject.get(), (CLIPFORMAT)
-  //     RegisterClipboardFormat(CFSTR_PREFERREDDROPEFFECT), medium);
-  // if (FAILED(hr))
-  // {
-  //   return;
-  // }
+  hr = NShell::DataObject_SetData_HGLOBAL(clipboardObject.get(), (CLIPFORMAT)
+      RegisterClipboardFormat(CFSTR_PREFERREDDROPEFFECT), medium);
+  if (FAILED(hr))
+  {
+    return;
+  }
+
   medium.hGlobal = NULL;
 
   OleSetClipboard(clipboardObject.get());
