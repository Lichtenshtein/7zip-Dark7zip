From bc5ea371a8d77fa63f09902fc2dfea5898848342 Mon Sep 17 00:00:00 2001
From: ironyman <ironyman13@gmail.com>
Date: Wed, 20 Dec 2023 01:20:46 -0800
Subject: [PATCH] Add copy files to clipboard

---
 CPP/7zip/UI/FileManager/PanelMenu.cpp | 60 ++++++++++++++------------
 CPP/Windows/Clipboard.cpp             | 62 ++++++++++++++++++++++++++-
 CPP/Windows/Clipboard.h               |  3 ++
 3 files changed, 96 insertions(+), 29 deletions(-)

diff --git a/CPP/7zip/UI/FileManager/PanelMenu.cpp b/CPP/7zip/UI/FileManager/PanelMenu.cpp
index beccc24..04279c2 100644
--- a/CPP/7zip/UI/FileManager/PanelMenu.cpp
+++ b/CPP/7zip/UI/FileManager/PanelMenu.cpp
@@ -188,7 +188,7 @@ void CPanel::Properties()
     InvokeSystemCommand("properties");
     return;
   }
-  
+
   {
     CListViewDialog message;
     // message.DeleteIsAllowed = false;
@@ -196,7 +196,7 @@ void CPanel::Properties()
 
     CRecordVector<UInt32> operatedIndices;
     Get_ItemIndices_Operated(operatedIndices);
-    
+
     if (operatedIndices.Size() == 1)
     {
       UInt32 index = operatedIndices[0];
@@ -209,10 +209,10 @@ void CPanel::Properties()
           CMyComBSTR name;
           PROPID propID;
           VARTYPE varType;
-          
+
           if (_folder->GetPropertyInfo(i, &name, &propID, &varType) != S_OK)
             continue;
-          
+
           NCOM::CPropVariant prop;
           if (_folder->GetProperty(index, propID, &prop) != S_OK)
             continue;
@@ -314,7 +314,7 @@ void CPanel::Properties()
       AddSeparator(message);
     }
 
-        
+
     /*
     AddLangString(message, IDS_PROP_FILE_TYPE);
     message += kPropValueSeparator;
@@ -371,7 +371,7 @@ void CPanel::Properties()
               const int kNumSpecProps = Z7_ARRAY_SIZE(kSpecProps);
 
               AddSeparator(message);
-              
+
               for (Int32 i = -(int)kNumSpecProps; i < (Int32)numProps; i++)
               {
                 CMyComBSTR name;
@@ -388,7 +388,7 @@ void CPanel::Properties()
               }
             }
           }
-          
+
           if (level2 < numLevels - 1)
           {
             const UInt32 level = numLevels - 1 - level2;
@@ -411,7 +411,7 @@ void CPanel::Properties()
             }
           }
         }
-        
+
         {
           // we ERROR message for NonOpen level
               bool needSep = true;
@@ -462,14 +462,18 @@ void CPanel::EditCopy()
   */
   UString s;
   CRecordVector<UInt32> indices;
+  std::vector<std::wstring> files;
   Get_ItemIndices_Selected(indices);
   FOR_VECTOR (i, indices)
   {
     if (i != 0)
       s += "\xD\n";
     s += GetItemName(indices[i]);
+  // MessageBox(0, GetItemFullPath(indices[i]).Ptr(),GetItemFullPath(indices[i]).Ptr(),0);
+    files.push_back(GetItemFullPath(indices[i]).Ptr());
   }
-  ClipboardSetText(_mainWindow, s);
+  // ClipboardSetText(_mainWindow, s);
+  ClipboardSetFiles(files);
 }
 
 void CPanel::EditPaste()
@@ -488,7 +492,7 @@ void CPanel::EditPaste()
   MessageBoxW(0, s, L"", 0);
   */
 
-  // InvokeSystemCommand("paste");
+  InvokeSystemCommand("paste");
 }
 
 
@@ -532,7 +536,7 @@ HRESULT CPanel::CreateShellContextMenu(
     // ShowMessage("Failed to get Desktop folder");
     return E_FAIL;
   }
-  
+
   CFolderPidls pidls;
   // NULL is allowed for parentHWND in ParseDisplayName()
   const HWND parentHWND_for_ParseDisplayName = GetParent();
@@ -591,7 +595,7 @@ HRESULT CPanel::CreateShellContextMenu(
         GetParent(), IID_IContextMenu, (void**)&systemContextMenu);
     */
   }
-  
+
   CMyComPtr<IShellFolder> parentFolder;
   RINOK(desktopFolder->BindToObject(pidls.parent,
       NULL, IID_IShellFolder, (void**)&parentFolder))
@@ -599,7 +603,7 @@ HRESULT CPanel::CreateShellContextMenu(
     return E_FAIL;
 
   ODS("==== CPanel::CreateShellContextMenu pidls START");
-  
+
   pidls.items.ClearAndReserve(operatedIndices.Size());
   UString fileName;
   FOR_VECTOR (i, operatedIndices)
@@ -712,7 +716,7 @@ void CPanel::CreateSystemMenu(HMENU menuSpec,
 
   if (!systemContextMenu)
     return;
-  
+
   /*
   // Set up a CMINVOKECOMMANDINFO structure.
   CMINVOKECOMMANDINFO ci;
@@ -720,7 +724,7 @@ void CPanel::CreateSystemMenu(HMENU menuSpec,
   ci.cbSize = sizeof(CMINVOKECOMMANDINFO);
   ci.hwnd = GetParent();
   */
-  
+
   /*
   if (Sender == GoBtn)
   {
@@ -735,13 +739,13 @@ void CPanel::CreateSystemMenu(HMENU menuSpec,
       action = "delete";
     else if (PropertiesRb->Checked)
       action = "properties";
-    
+
     ci.lpVerb = action.c_str();
     result = cm->InvokeCommand(&ci);
     if (result)
       ShowMessage(
       "Error copying file to clipboard.");
-    
+
   }
   else
   */
@@ -763,7 +767,7 @@ void CPanel::CreateSystemMenu(HMENU menuSpec,
       #ifdef SHOW_DEBUG_FM_CTX_MENU
       PrintAllContextItems(systemContextMenu, (unsigned)res);
       #endif
-      
+
       CMenu menu;
       menu.Attach(menuSpec);
       CMenuItem menuItem;
@@ -912,10 +916,10 @@ bool CPanel::CheckBeforeUpdate(UINT resourceID)
       folder = _folder;
     else
       folder = _parentFolders[i].ParentFolder;
-    
+
     if (!IsReadOnlyFolder(folder))
       continue;
-    
+
     UString s;
     AddLangString(s, resourceID);
     s.Add_LF();
@@ -966,7 +970,7 @@ void CPanel::CreateFileMenu(HMENU menuSpec,
   */
 
   CFileMenu fm;
-  
+
   fm.readOnly = IsThereReadOnlyFolder();
   fm.isHashFolder = IsHashFolder();
   fm.isFsFolder = Is_IO_FS_Folder();
@@ -975,7 +979,7 @@ void CPanel::CreateFileMenu(HMENU menuSpec,
   fm.numItems = operatedIndices.Size();
 
   fm.isAltStreamsSupported = false;
-  
+
   if (fm.numItems == 1)
     fm.FilePath = us2fs(GetItemFullPath(operatedIndices[0]));
 
@@ -1036,10 +1040,10 @@ bool CPanel::InvokePluginCommand(unsigned id,
     CMINVOKECOMMANDINFO
   #endif
       commandInfo;
-  
+
   memset(&commandInfo, 0, sizeof(commandInfo));
   commandInfo.cbSize = sizeof(commandInfo);
-  
+
   commandInfo.fMask = 0
   #ifdef use_CMINVOKECOMMANDINFOEX
     | CMIC_MASK_UNICODE
@@ -1054,9 +1058,9 @@ bool CPanel::InvokePluginCommand(unsigned id,
   const AString currentFolderA (GetAnsiString(_currentFolderPrefix));
   commandInfo.lpDirectory = (LPCSTR)(currentFolderA);
   commandInfo.nShow = SW_SHOW;
-  
+
   #ifdef use_CMINVOKECOMMANDINFOEX
-  
+
   commandInfo.lpParametersW = NULL;
   commandInfo.lpTitle = "";
 
@@ -1078,9 +1082,9 @@ bool CPanel::InvokePluginCommand(unsigned id,
   // commandInfo.ptInvoke.y = yPos;
   commandInfo.ptInvoke.x = 0;
   commandInfo.ptInvoke.y = 0;
-  
+
   #endif
-  
+
   HRESULT result;
   if (isSystemMenu)
     result = systemContextMenu->InvokeCommand(LPCMINVOKECOMMANDINFO(&commandInfo));
diff --git a/CPP/Windows/Clipboard.cpp b/CPP/Windows/Clipboard.cpp
index 90c4864..8ba4219 100644
--- a/CPP/Windows/Clipboard.cpp
+++ b/CPP/Windows/Clipboard.cpp
@@ -126,5 +126,65 @@ bool ClipboardSetText(HWND owner, const UString &s)
   #endif
   return res;
 }
- 
+
+void ClipboardSetFiles(const std::vector<std::wstring>& filePaths)
+{
+  // Open the clipboard
+  if (!OpenClipboard(nullptr))
+  {
+    return;
+  }
+  // Clear the clipboard
+  EmptyClipboard();
+
+  // Allocate memory for the DROPFILES structure
+  size_t fileBufferSize = 0;
+  for (const auto &filePath : filePaths)
+  {
+    fileBufferSize += filePath.length() + 1;
+  }
+  // For the second null terminator.
+  fileBufferSize += 1;
+
+  HGLOBAL hGlobal = GlobalAlloc(GMEM_MOVEABLE | GHND | GMEM_SHARE, sizeof(DROPFILES) + fileBufferSize * sizeof(wchar_t));
+  if (hGlobal == nullptr)
+  {
+    return;
+  }
+
+  // from #include <ShlObj.h>
+  DROPFILES *dropFiles = static_cast<DROPFILES *>(GlobalLock(hGlobal));
+  if (dropFiles == nullptr)
+  {
+    return;
+  }
+  dropFiles->pFiles = sizeof(DROPFILES);
+  dropFiles->pt.x = 0;
+  dropFiles->pt.y = 0;
+  dropFiles->fNC = FALSE;
+  dropFiles->fWide = TRUE;
+
+  wchar_t *fileBuffer = reinterpret_cast<wchar_t *>(dropFiles + 1);
+  wchar_t *fileBufferPos = fileBuffer;
+  for (const auto &filePath : filePaths)
+  {
+    int ret = wcsncpy_s(fileBufferPos, fileBufferSize - (fileBufferPos - fileBuffer),
+              filePath.c_str(), filePath.length());
+    if (ret != 0)
+    {
+      MessageBox(0, L"HI", L"HI", 0);
+    }
+    fileBufferPos += filePath.length() + 1;
+  }
+  // __debugbreak();
+  fileBufferPos[0] = '\0';
+  GlobalUnlock(hGlobal);
+
+  // Set the clipboard data
+  SetClipboardData(CF_HDROP, hGlobal);
+
+  // Close the clipboard
+  CloseClipboard();
 }
+
+}
\ No newline at end of file
diff --git a/CPP/Windows/Clipboard.h b/CPP/Windows/Clipboard.h
index 70fe6c4..fd26442 100644
--- a/CPP/Windows/Clipboard.h
+++ b/CPP/Windows/Clipboard.h
@@ -4,6 +4,8 @@
 #define ZIP7_INC_CLIPBOARD_H
 
 #include "../Common/MyString.h"
+#include <vector>
+#include <string>
 
 namespace NWindows {
 
@@ -22,6 +24,7 @@ bool ClipboardIsFormatAvailableHDROP();
 // bool ClipboardGetFileNames(UStringVector &names);
 // bool ClipboardGetTextString(AString &s);
 bool ClipboardSetText(HWND owner, const UString &s);
+void ClipboardSetFiles(const std::vector<std::wstring>& filePaths);
 
 }
 
