From 8a5e76a10e3faabebaff9e166d727814e0e536e2 Mon Sep 17 00:00:00 2001
From: ironyman <ironyman13@gmail.com>
Date: Wed, 20 Dec 2023 03:04:58 -0800
Subject: [PATCH] Allow navigate to ~

---
 CPP/7zip/UI/FileManager/FM.mak                |  5 +-
 CPP/7zip/UI/FileManager/PanelFolderChange.cpp | 66 ++++++++++---------
 CPP/7zip/UI/FileManager/Path.cpp              | 30 +++++++++
 CPP/7zip/UI/FileManager/Path.h                |  5 ++
 4 files changed, 72 insertions(+), 34 deletions(-)
 create mode 100644 CPP/7zip/UI/FileManager/Path.cpp
 create mode 100644 CPP/7zip/UI/FileManager/Path.h

diff --git a/CPP/7zip/UI/FileManager/FM.mak b/CPP/7zip/UI/FileManager/FM.mak
index be04f1e..118c5c0 100644
--- a/CPP/7zip/UI/FileManager/FM.mak
+++ b/CPP/7zip/UI/FileManager/FM.mak
@@ -4,8 +4,8 @@ CFLAGS = $(CFLAGS) \
 !IFDEF UNDER_CE
 LIBS = $(LIBS) ceshell.lib Commctrl.lib
 !ELSE
-LIBS = $(LIBS) comctl32.lib htmlhelp.lib comdlg32.lib Mpr.lib Gdi32.lib
-CFLAGS = $(CFLAGS) -DZ7_LONG_PATH -DZ7_DEVICE_FILE
+LIBS = $(LIBS) comctl32.lib htmlhelp.lib comdlg32.lib Mpr.lib Gdi32.lib shlwapi.lib
+CFLAGS = $(CFLAGS) -DZ7_LONG_PATH -DZ7_DEVICE_FILE /std:c++17
 LFLAGS = $(LFLAGS) /DELAYLOAD:mpr.dll
 LIBS = $(LIBS) delayimp.lib
 !ENDIF
@@ -69,6 +69,7 @@ FM_OBJS = \
   $O\SplitDialog.obj \
   $O\SystemPage.obj \
   $O\VerCtrl.obj \
+  $O\Path.obj \
 
 !IFNDEF UNDER_CE
 
diff --git a/CPP/7zip/UI/FileManager/PanelFolderChange.cpp b/CPP/7zip/UI/FileManager/PanelFolderChange.cpp
index 47fe921..5562111 100644
--- a/CPP/7zip/UI/FileManager/PanelFolderChange.cpp
+++ b/CPP/7zip/UI/FileManager/PanelFolderChange.cpp
@@ -23,6 +23,7 @@
 #include "ViewSettings.h"
 
 #include "resource.h"
+#include "Path.h"
 
 using namespace NWindows;
 using namespace NFile;
@@ -39,7 +40,7 @@ void CPanel::ReleaseFolder()
   _folderRawProps.Release();
   _folderAltStreams.Release();
   _folderOperations.Release();
-  
+
   _thereAreDeletedItems = false;
 }
 
@@ -61,7 +62,7 @@ void CPanel::SetToRootFolder()
 {
   ReleaseFolder();
   _library.Free();
-  
+
   CRootFolder *rootFolderSpec = new CRootFolder;
   SetNewFolder(rootFolderSpec);
   rootFolderSpec->Init();
@@ -82,7 +83,7 @@ HRESULT CPanel::BindToPath(const UString &fullPath, const UString &arcFormat, CO
 
   openRes.ArchiveIsOpened = false;
   openRes.Encrypted = false;
-  
+
   CDisableTimerProcessing disableTimerProcessing(*this);
   CDisableNotify disableNotify(*this);
 
@@ -102,7 +103,7 @@ HRESULT CPanel::BindToPath(const UString &fullPath, const UString &arcFormat, CO
       else
         relatPath.Delete(0);
     }
-    
+
     UString relatPath2 = relatPath;
     if (!relatPath2.IsEmpty() && !IS_PATH_SEPAR(relatPath2.Back()))
       relatPath2.Add_PathSepar();
@@ -138,7 +139,7 @@ HRESULT CPanel::BindToPath(const UString &fullPath, const UString &arcFormat, CO
     const unsigned prefixSize = NName::GetRootPrefixSize(sysPath);
     if (prefixSize == 0 || sysPath[prefixSize] == 0)
       sysPath.Empty();
-    
+
     #if defined(_WIN32) && !defined(UNDER_CE)
     if (!sysPath.IsEmpty() && sysPath.Back() == ':' &&
       (sysPath.Len() != 2 || !NName::IsDrivePath2(sysPath)))
@@ -150,9 +151,9 @@ HRESULT CPanel::BindToPath(const UString &fullPath, const UString &arcFormat, CO
         sysPath.Empty();
     }
     #endif
-    
+
     CFileInfo fileInfo;
-    
+
     while (!sysPath.IsEmpty())
     {
       if (sysPath.Len() <= prefixSize)
@@ -202,11 +203,11 @@ HRESULT CPanel::BindToPath(const UString &fullPath, const UString &arcFormat, CO
         sysPath.DeleteFrom((unsigned)pos);
       }
     }
-    
+
     SetToRootFolder();
 
     CMyComPtr<IFolderFolder> newFolder;
-  
+
     if (sysPath.IsEmpty())
     {
       _folder->BindToFolder(path, &newFolder);
@@ -230,11 +231,11 @@ HRESULT CPanel::BindToPath(const UString &fullPath, const UString &arcFormat, CO
     else
     {
       FString dirPrefix, fileName;
-      
+
       NDir::GetFullPathAndSplit(us2fs(sysPath), dirPrefix, fileName);
 
       HRESULT res = S_OK;
-      
+
       #ifdef _WIN32
       if (DoesNameContainWildcard_SkipRoot(fs2us(dirPrefix)))
         return E_INVALIDARG;
@@ -250,7 +251,7 @@ HRESULT CPanel::BindToPath(const UString &fullPath, const UString &arcFormat, CO
         tfi.FilePath = us2fs(sysPath);
         res = OpenAsArc(NULL, tfi, sysPath, arcFormat, openRes);
       }
-      
+
       if (res == S_FALSE)
         _folder->BindToFolder(fs2us(dirPrefix), &newFolder);
       else
@@ -263,7 +264,7 @@ HRESULT CPanel::BindToPath(const UString &fullPath, const UString &arcFormat, CO
           path.Delete(0);
       }
     }
-    
+
     if (newFolder)
     {
       SetNewFolder(newFolder);
@@ -271,7 +272,7 @@ HRESULT CPanel::BindToPath(const UString &fullPath, const UString &arcFormat, CO
       return S_OK;
     }
   }
-  
+
   {
     // ---------- we open folder remPath in archive and sub archives ----------
 
@@ -301,7 +302,7 @@ HRESULT CPanel::BindToPath(const UString &fullPath, const UString &arcFormat, CO
             curPos += (unsigned)pos + 1;
         }
       }
-      
+
       if (!newFolder)
         break;
 
@@ -318,7 +319,7 @@ HRESULT CPanel::BindToPathAndRefresh(const UString &path)
   CDisableNotify disableNotify(*this);
   COpenResult openRes;
   UString s = path;
-  
+
   #ifdef _WIN32
     if (!s.IsEmpty() && s[0] == '\"' && s.Back() == '\"')
     {
@@ -418,7 +419,7 @@ void CPanel::LoadFullPathAndShow()
   }
   item.iItem = -1;
   _headerComboBox.SetItem(&item);
-  
+
   #endif
 
   RefreshTitle();
@@ -427,7 +428,8 @@ void CPanel::LoadFullPathAndShow()
 #ifndef UNDER_CE
 LRESULT CPanel::OnNotifyComboBoxEnter(const UString &s)
 {
-  if (BindToPathAndRefresh(GetUnicodeString(s)) == S_OK)
+  auto path = ExpandEnvironmentStringsWrapper(std::wstring(s == L"~" ? L"%USERPROFILE%" : s));
+  if (path && BindToPathAndRefresh(GetUnicodeString(UString((*path).data()))) == S_OK)
   {
     PostMsg(kSetFocusToListView);
     return TRUE;
@@ -504,9 +506,9 @@ void CPanel::AddComboBoxItem(const UString &name, int iconIndex, int indent, boo
   for (int i = 0; i < indent; i++)
     s += "  ";
   _headerComboBox.AddString(s + name);
-  
+
   #else
-  
+
   COMBOBOXEXITEMW item;
   item.mask = CBEIF_TEXT | CBEIF_INDENT;
   item.iSelectedImage = item.iImage = iconIndex;
@@ -516,7 +518,7 @@ void CPanel::AddComboBoxItem(const UString &name, int iconIndex, int indent, boo
   item.iIndent = indent;
   item.pszText = name.Ptr_non_const();
   _headerComboBox.InsertItem(&item);
-  
+
   #endif
 
   if (addToList)
@@ -536,10 +538,10 @@ bool CPanel::OnComboBoxCommand(UINT code, LPARAM /* param */, LRESULT &result)
     {
       ComboBoxPaths.Clear();
       _headerComboBox.ResetContent();
-      
+
       unsigned i;
       UStringVector pathParts;
-      
+
       SplitPathToParts(_currentFolderPrefix, pathParts);
       UString sumPass;
       if (!pathParts.IsEmpty())
@@ -570,7 +572,7 @@ bool CPanel::OnComboBoxCommand(UINT code, LPARAM /* param */, LRESULT &result)
 
       name = RootFolder_GetName_Computer(iconIndex);
       AddComboBoxItem(name, iconIndex, 0, true);
-        
+
       FStringVector driveStrings;
       MyGetLogicalDriveStrings(driveStrings);
       for (i = 0; i < driveStrings.Size(); i++)
@@ -587,7 +589,7 @@ bool CPanel::OnComboBoxCommand(UINT code, LPARAM /* param */, LRESULT &result)
       AddComboBoxItem(name, iconIndex, 0, true);
 
       #endif
-    
+
       return false;
     }
 
@@ -708,10 +710,10 @@ UString CPanel::GetParentDirPrefix() const
 void CPanel::OpenParentFolder()
 {
   LoadFullPath(); // Maybe we don't need it ??
-  
+
   UString parentFolderPrefix;
   UString focusedName;
-  
+
   if (!_currentFolderPrefix.IsEmpty())
   {
     wchar_t c = _currentFolderPrefix.Back();
@@ -742,12 +744,12 @@ void CPanel::OpenParentFolder()
 
   CDisableTimerProcessing disableTimerProcessing(*this);
   CDisableNotify disableNotify(*this);
-  
+
   CMyComPtr<IFolderFolder> newFolder;
   _folder->BindToParentFolder(&newFolder);
 
   // newFolder.Release(); // for test
-  
+
   if (newFolder)
     SetNewFolder(newFolder);
   else
@@ -763,7 +765,7 @@ void CPanel::OpenParentFolder()
       CloseOneLevel();
       needSetFolder = (!_folder);
     }
-    
+
     if (needSetFolder)
     {
       {
@@ -772,7 +774,7 @@ void CPanel::OpenParentFolder()
       }
     }
   }
-    
+
   CSelectedState state;
   state.FocusedName = focusedName;
   state.FocusedName_Defined = true;
@@ -894,7 +896,7 @@ void CPanel::OpenAltStreams()
     }
     return;
   }
-  
+
   #if defined(_WIN32) && !defined(UNDER_CE)
   UString path;
   if (realIndex >= 0)
diff --git a/CPP/7zip/UI/FileManager/Path.cpp b/CPP/7zip/UI/FileManager/Path.cpp
new file mode 100644
index 0000000..0c155d2
--- /dev/null
+++ b/CPP/7zip/UI/FileManager/Path.cpp
@@ -0,0 +1,30 @@
+#pragma once
+#include "StdAfx.h"
+#include <Shlwapi.h>
+#include "Path.h"
+
+std::optional<std::wstring> ExpandEnvironmentStringsWrapper(const std::wstring &sourceString)
+{
+	auto length = ExpandEnvironmentStrings(sourceString.c_str(), nullptr, 0);
+
+	if (length == 0)
+	{
+		return std::nullopt;
+	}
+
+	std::wstring expandedString;
+	expandedString.resize(length);
+
+	length = ExpandEnvironmentStrings(sourceString.c_str(), expandedString.data(), length);
+
+	if (length == 0)
+	{
+		return std::nullopt;
+	}
+
+	// length includes the terminating NULL character, which shouldn't be included in the actual
+	// string.
+	expandedString.resize(length - 1);
+
+	return expandedString;
+}
diff --git a/CPP/7zip/UI/FileManager/Path.h b/CPP/7zip/UI/FileManager/Path.h
new file mode 100644
index 0000000..30ce494
--- /dev/null
+++ b/CPP/7zip/UI/FileManager/Path.h
@@ -0,0 +1,5 @@
+
+#include <optional>
+#include <string>
+
+std::optional<std::wstring> ExpandEnvironmentStringsWrapper(const std::wstring &sourceString);
\ No newline at end of file
