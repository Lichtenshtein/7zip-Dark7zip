From 8428f58165fca575b1db57e9736efdb2c9f8208b Mon Sep 17 00:00:00 2001
From: ironyman <ironyman13@gmail.com>
Date: Fri, 5 Jan 2024 01:57:09 -0800
Subject: [PATCH] Make history cleaner

---
 CPP/7zip/UI/FileManager/App.h                 |  1 +
 CPP/7zip/UI/FileManager/MultiPanel.cpp        | 20 ++++++++++++-------
 CPP/7zip/UI/FileManager/Panel.h               |  3 +++
 CPP/7zip/UI/FileManager/PanelFolderChange.cpp |  9 ++++++++-
 CPP/Windows/Clipboard.cpp                     |  2 +-
 5 files changed, 26 insertions(+), 9 deletions(-)

diff --git a/CPP/7zip/UI/FileManager/App.h b/CPP/7zip/UI/FileManager/App.h
index 1b23ae1..8e5486b 100644
--- a/CPP/7zip/UI/FileManager/App.h
+++ b/CPP/7zip/UI/FileManager/App.h
@@ -59,6 +59,7 @@ class CPanelCallbackImp Z7_final: public CPanelCallback
   virtual HRESULT OnOpenFolder(std::optional<std::reference_wrapper<bool>> shouldReturn = std::nullopt) Z7_override;
   virtual HRESULT OnOpenParentFolder() Z7_override;
   virtual UString OnSetComboText(UString const& text) Z7_override;
+  virtual bool IsMultiPanelMode() Z7_override;
 };
 
 
diff --git a/CPP/7zip/UI/FileManager/MultiPanel.cpp b/CPP/7zip/UI/FileManager/MultiPanel.cpp
index c33e878..7fffc06 100644
--- a/CPP/7zip/UI/FileManager/MultiPanel.cpp
+++ b/CPP/7zip/UI/FileManager/MultiPanel.cpp
@@ -193,23 +193,24 @@ HRESULT CPanelCallbackImp::OnOpenFolder(std::optional<std::reference_wrapper<boo
     return S_OK;
   }
 
+  if (shouldReturn.has_value())
+  {
+    shouldReturn->get() = false;
+  }
+
   if (_index != 1)
   {
     auto cwd = _app->Panels[_index].GetFsPath();
     _app->Panels[1].BindToPathAndRefresh(cwd);
+
+    // This is to notify OnNotifyComboBoxEnter to skip default action.
     if (shouldReturn.has_value())
     {
       shouldReturn->get() = true;
     }
   }
-  else
-  {
-    if (shouldReturn.has_value())
-    {
-      shouldReturn->get() = false;
-    }
-  }
 
+  _app->Panels[1]._appState->FolderHistory.AddString(_app->Panels[1]._currentFolderPrefix);
   _app->SyncMultiPanel();
 
   _app->Panels[1]._listView.SetItemState_Selected(0, true);
@@ -242,3 +243,8 @@ UString CPanelCallbackImp::OnSetComboText(UString const& text)
 
   // _app->Panels[1].SetFocusToList();
 }
+
+bool CPanelCallbackImp::IsMultiPanelMode()
+{
+  return _app->MultiPanelMode != 0;
+}
\ No newline at end of file
diff --git a/CPP/7zip/UI/FileManager/Panel.h b/CPP/7zip/UI/FileManager/Panel.h
index 9cbe33c..d349c00 100644
--- a/CPP/7zip/UI/FileManager/Panel.h
+++ b/CPP/7zip/UI/FileManager/Panel.h
@@ -84,6 +84,7 @@ DECLARE_INTERFACE(CPanelCallback)
   virtual HRESULT OnOpenFolder(std::optional<std::reference_wrapper<bool>> shouldReturn = std::nullopt) = 0;
   virtual HRESULT OnOpenParentFolder() = 0;
   virtual UString OnSetComboText(UString const& text) = 0;
+  virtual bool IsMultiPanelMode() = 0;
 
 };
 Z7_PURE_INTERFACES_END
@@ -582,6 +583,7 @@ class CPanel Z7_final: public NWindows::NControl::CWindow2
   void SaveListViewInfo();
 
   CPanel() :
+      _panelCallback(NULL),
       _thereAre_ListView_Items(false),
       _exStyle(0),
       _showDots(false),
@@ -995,6 +997,7 @@ class CPanel Z7_final: public NWindows::NControl::CWindow2
 
   // friend HRESULT CApp::InitializeMultiPanel();
   friend class CApp;
+  friend class CPanelCallbackImp;
 };
 
 class CMyBuffer
diff --git a/CPP/7zip/UI/FileManager/PanelFolderChange.cpp b/CPP/7zip/UI/FileManager/PanelFolderChange.cpp
index 2092496..8b8fab5 100644
--- a/CPP/7zip/UI/FileManager/PanelFolderChange.cpp
+++ b/CPP/7zip/UI/FileManager/PanelFolderChange.cpp
@@ -391,7 +391,11 @@ static int GetRealIconIndex(CFSTR path, DWORD attributes)
 void CPanel::LoadFullPathAndShow()
 {
   LoadFullPath();
-  _appState->FolderHistory.AddString(_currentFolderPrefix);
+  // _panelCallback might not be initialized yet..
+  if (_panelCallback == NULL || !_panelCallback->IsMultiPanelMode())
+  {
+    _appState->FolderHistory.AddString(_currentFolderPrefix);
+  }
 
   SetComboText(_currentFolderPrefix);
 
@@ -698,7 +702,10 @@ void CPanel::FoldersHistory()
       selectString = listViewDialog.Strings[listViewDialog.FocusedItemIndex];
   }
   if (listViewDialog.FocusedItemIndex >= 0)
+  {
     BindToPathAndRefresh(selectString);
+    _panelCallback->OnOpenFolder();
+  }
 }
 
 
diff --git a/CPP/Windows/Clipboard.cpp b/CPP/Windows/Clipboard.cpp
index 2f61d35..0024403 100644
--- a/CPP/Windows/Clipboard.cpp
+++ b/CPP/Windows/Clipboard.cpp
@@ -347,7 +347,7 @@ void ClipboardSetFiles(HWND owner, const std::vector<std::wstring>& filePaths, D
   fileBufferPos = fileBuffer;
   for (const auto &filePath : filePaths)
   {
-    int ret = wcsncpy_s(fileBufferPos, fileBufferSize - (fileBufferPos - fileBuffer),
+    wcsncpy_s(fileBufferPos, fileBufferSize - (fileBufferPos - fileBuffer),
               filePath.c_str(), filePath.length());
     fileBufferPos += filePath.length() + 1;
   }
