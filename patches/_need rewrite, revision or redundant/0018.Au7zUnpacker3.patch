From 6f4fe2b386a6a3a4faec93000cfef960c2bfaf27 Mon Sep 17 00:00:00 2001
From: Alexey Tatarenko <alexey.tatarenko@aura.com>
Date: Fri, 14 Jun 2024 11:20:05 +0300
Subject: [PATCH] Implemented unit tests

---
 CPP/7zip/UI/Console/Console.vcxproj | 10 ++--
 CPP/7zip/UI/Console/Main.cpp        | 12 ++--
 Test_7zip/Test_7zip.vcxproj         | 24 ++++++--
 Test_7zip/test_7zip.cpp             | 87 ++++++++++++++++++++++++++++-
 4 files changed, 114 insertions(+), 19 deletions(-)

diff --git a/CPP/7zip/UI/Console/Console.vcxproj b/CPP/7zip/UI/Console/Console.vcxproj
index d49f6113..d34df8e9 100644
--- a/CPP/7zip/UI/Console/Console.vcxproj
+++ b/CPP/7zip/UI/Console/Console.vcxproj
@@ -277,9 +277,9 @@
       </HeaderFileName>
     </Midl>
     <ClCompile>
-      <Optimization>MinSpace</Optimization>
-      <InlineFunctionExpansion>OnlyExplicitInline</InlineFunctionExpansion>
-      <PreprocessorDefinitions>NDEBUG;WIN32;_CONSOLE;WIN_LONG_PATH;EXTERNAL_CODECS;_7ZIP_LARGE_PAGES;SUPPORT_DEVICE_FILE;%(PreprocessorDefinitions)</PreprocessorDefinitions>
+      <Optimization>Disabled</Optimization>
+      <InlineFunctionExpansion>Disabled</InlineFunctionExpansion>
+      <PreprocessorDefinitions>NDEBUG;WIN32;_CONSOLE;WIN_LONG_PATH;Z7_EXTERNAL_CODECS;_7ZIP_LARGE_PAGES;SUPPORT_DEVICE_FILE;%(PreprocessorDefinitions)</PreprocessorDefinitions>
       <StringPooling>true</StringPooling>
       <RuntimeLibrary>MultiThreaded</RuntimeLibrary>
       <FunctionLevelLinking>true</FunctionLevelLinking>
@@ -377,8 +377,8 @@
       </HeaderFileName>
     </Midl>
     <ClCompile>
-      <Optimization>MinSpace</Optimization>
-      <InlineFunctionExpansion>OnlyExplicitInline</InlineFunctionExpansion>
+      <Optimization>Disabled</Optimization>
+      <InlineFunctionExpansion>Disabled</InlineFunctionExpansion>
       <PreprocessorDefinitions>NDEBUG;WIN32;_CONSOLE;WIN_LONG_PATH;Z7_EXTERNAL_CODECS;_7ZIP_LARGE_PAGES;SUPPORT_DEVICE_FILE;%(PreprocessorDefinitions)</PreprocessorDefinitions>
       <StringPooling>true</StringPooling>
       <RuntimeLibrary>MultiThreaded</RuntimeLibrary>
diff --git a/CPP/7zip/UI/Console/Main.cpp b/CPP/7zip/UI/Console/Main.cpp
index b77bbb94..3db93c26 100644
--- a/CPP/7zip/UI/Console/Main.cpp
+++ b/CPP/7zip/UI/Console/Main.cpp
@@ -812,7 +812,8 @@ int Main2(
     return 0;
 }
 
-int ExtractArchiveFile(TCHAR * chAction, TCHAR * chArchiveName, TCHAR * chInOutputFolderName, TCHAR * chPassword, TCHAR * chFileFilter, ScanFileState * pScanFileState)
+int ExtractArchiveFile(const TCHAR* chAction, const TCHAR* chArchiveName, const TCHAR* chInOutputFolderName,
+    const TCHAR* chPassword, const TCHAR* chFileFilter, ScanFileState* pScanFileState)
 {
   #if defined(MY_CPU_SIZEOF_POINTER)
     { unsigned k = sizeof(void *); if (k != MY_CPU_SIZEOF_POINTER) throw "incorrect MY_CPU_PTR_SIZE"; }
@@ -1633,8 +1634,9 @@ int ExtractArchiveFile(TCHAR * chAction, TCHAR * chArchiveName, TCHAR * chInOutp
     Description		: It is a exported function which calls "ExtractFile" for extraction purpose
 --------------------------------------------------------------------------------------*/
 
-BOOL WINAPI __stdcall UnMax7zArchive(TCHAR* chAction, TCHAR* chArchiveName, TCHAR* chOutputFolderName,
-    TCHAR* chPassword, TCHAR* chFileFilter, ScanFileState* pScanFileState)
+bool WINAPI __stdcall UnMax7zArchive(const TCHAR* chAction, const TCHAR* chArchiveName,
+    const TCHAR* chOutputFolderName, const TCHAR* chPassword, const TCHAR* chFileFilter,
+    ScanFileState* pScanFileState)
 {
   int iRet = ExtractArchiveFile(chAction, chArchiveName, chOutputFolderName,
       chPassword, chFileFilter, pScanFileState);
@@ -1651,8 +1653,8 @@ Purpose			: Exported function to call "ExtractFile" for extraction purpose
 Author			: Sandip Sanap
 Description		: It is a exported function which calls "ExtractFile" for extraction purpose
 --------------------------------------------------------------------------------------*/
-BOOL WINAPI __stdcall Max7zArchive(TCHAR* chAction, TCHAR* chArchiveName, TCHAR* chInputFileFolderName,
-    TCHAR* chPassword, TCHAR* chFileFilter)
+bool WINAPI __stdcall Max7zArchive(const TCHAR* chAction, const TCHAR* chArchiveName,
+    const TCHAR* chInputFileFolderName, const TCHAR* chPassword, const TCHAR* chFileFilter)
 {
   int iRet = ExtractArchiveFile(chAction, chArchiveName, chInputFileFolderName, chPassword, chFileFilter, NULL);
   return iRet == 0;
diff --git a/Test_7zip/Test_7zip.vcxproj b/Test_7zip/Test_7zip.vcxproj
index ee8afc47..2b56ad1b 100644
--- a/Test_7zip/Test_7zip.vcxproj
+++ b/Test_7zip/Test_7zip.vcxproj
@@ -62,9 +62,11 @@
   </PropertyGroup>
   <PropertyGroup Label="Configuration" Condition="'$(Configuration)|$(Platform)'=='Development|Win32'">
     <PlatformToolset>v143</PlatformToolset>
+    <CharacterSet>Unicode</CharacterSet>
   </PropertyGroup>
   <PropertyGroup Label="Configuration" Condition="'$(Configuration)|$(Platform)'=='Development|x64'">
     <PlatformToolset>v143</PlatformToolset>
+    <CharacterSet>Unicode</CharacterSet>
   </PropertyGroup>
   <Import Project="$(VCTargetsPath)\Microsoft.Cpp.props" />
   <ImportGroup Label="ExtensionSettings">
@@ -114,11 +116,12 @@
       <SDLCheck>true</SDLCheck>
       <PreprocessorDefinitions>WIN32;_DEBUG;_CONSOLE;%(PreprocessorDefinitions)</PreprocessorDefinitions>
       <ConformanceMode>true</ConformanceMode>
-      <AdditionalIncludeDirectories>$(SolutionDir)ThirdParty\catch2;%(AdditionalIncludeDirectories)</AdditionalIncludeDirectories>
+      <AdditionalIncludeDirectories>$(SolutionDir)ThirdParty\catch2;$(SolutionDir)CPP\7zip\UI\Common\;%(AdditionalIncludeDirectories)</AdditionalIncludeDirectories>
       <AssemblerListingLocation>$(SolutionDir)Output\$(Platform)\$(Configuration)\Intermediate\$(ProjectName)\</AssemblerListingLocation>
       <ObjectFileName>$(SolutionDir)Output\$(Platform)\$(Configuration)\Intermediate\$(ProjectName)\</ObjectFileName>
       <PrecompiledHeaderOutputFile>$(SolutionDir)Output\$(Platform)\$(Configuration)\Intermediate\$(ProjectName)\Test_7zip.pch</PrecompiledHeaderOutputFile>
       <ProgramDataBaseFileName>$(SolutionDir)Output\$(Platform)\$(Configuration)\Intermediate\$(ProjectName)\</ProgramDataBaseFileName>
+      <LanguageStandard>stdcpp20</LanguageStandard>
     </ClCompile>
     <Link>
       <SubSystem>Console</SubSystem>
@@ -133,11 +136,12 @@
       <SDLCheck>true</SDLCheck>
       <PreprocessorDefinitions>WIN32;NDEBUG;_CONSOLE;%(PreprocessorDefinitions)</PreprocessorDefinitions>
       <ConformanceMode>true</ConformanceMode>
-      <AdditionalIncludeDirectories>$(SolutionDir)ThirdParty\catch2;%(AdditionalIncludeDirectories)</AdditionalIncludeDirectories>
+      <AdditionalIncludeDirectories>$(SolutionDir)ThirdParty\catch2;$(SolutionDir)CPP\7zip\UI\Common\;%(AdditionalIncludeDirectories)</AdditionalIncludeDirectories>
       <AssemblerListingLocation>$(SolutionDir)Output\$(Platform)\$(Configuration)\Intermediate\$(ProjectName)\</AssemblerListingLocation>
       <ObjectFileName>$(SolutionDir)Output\$(Platform)\$(Configuration)\Intermediate\$(ProjectName)\</ObjectFileName>
       <PrecompiledHeaderOutputFile>$(SolutionDir)Output\$(Platform)\$(Configuration)\Intermediate\$(ProjectName)\Test_7zip.pch</PrecompiledHeaderOutputFile>
       <ProgramDataBaseFileName>$(SolutionDir)Output\$(Platform)\$(Configuration)\Intermediate\$(ProjectName)\</ProgramDataBaseFileName>
+      <LanguageStandard>stdcpp20</LanguageStandard>
     </ClCompile>
     <Link>
       <SubSystem>Console</SubSystem>
@@ -152,11 +156,12 @@
       <SDLCheck>true</SDLCheck>
       <PreprocessorDefinitions>_DEBUG;_CONSOLE;%(PreprocessorDefinitions)</PreprocessorDefinitions>
       <ConformanceMode>true</ConformanceMode>
-      <AdditionalIncludeDirectories>$(SolutionDir)ThirdParty\catch2;%(AdditionalIncludeDirectories)</AdditionalIncludeDirectories>
+      <AdditionalIncludeDirectories>$(SolutionDir)ThirdParty\catch2;$(SolutionDir)CPP\7zip\UI\Common\;%(AdditionalIncludeDirectories)</AdditionalIncludeDirectories>
       <AssemblerListingLocation>$(SolutionDir)Output\$(Platform)\$(Configuration)\Intermediate\$(ProjectName)\</AssemblerListingLocation>
       <ObjectFileName>$(SolutionDir)Output\$(Platform)\$(Configuration)\Intermediate\$(ProjectName)\</ObjectFileName>
       <PrecompiledHeaderOutputFile>$(SolutionDir)Output\$(Platform)\$(Configuration)\Intermediate\$(ProjectName)\Test_7zip.pch</PrecompiledHeaderOutputFile>
       <ProgramDataBaseFileName>$(SolutionDir)Output\$(Platform)\$(Configuration)\Intermediate\$(ProjectName)\</ProgramDataBaseFileName>
+      <LanguageStandard>stdcpp20</LanguageStandard>
     </ClCompile>
     <Link>
       <SubSystem>Console</SubSystem>
@@ -171,11 +176,12 @@
       <SDLCheck>true</SDLCheck>
       <PreprocessorDefinitions>NDEBUG;_CONSOLE;%(PreprocessorDefinitions)</PreprocessorDefinitions>
       <ConformanceMode>true</ConformanceMode>
-      <AdditionalIncludeDirectories>$(SolutionDir)ThirdParty\catch2;%(AdditionalIncludeDirectories)</AdditionalIncludeDirectories>
+      <AdditionalIncludeDirectories>$(SolutionDir)ThirdParty\catch2;$(SolutionDir)CPP\7zip\UI\Common\;%(AdditionalIncludeDirectories)</AdditionalIncludeDirectories>
       <AssemblerListingLocation>$(SolutionDir)Output\$(Platform)\$(Configuration)\Intermediate\$(ProjectName)\</AssemblerListingLocation>
       <ObjectFileName>$(SolutionDir)Output\$(Platform)\$(Configuration)\Intermediate\$(ProjectName)\</ObjectFileName>
       <PrecompiledHeaderOutputFile>$(SolutionDir)Output\$(Platform)\$(Configuration)\Intermediate\$(ProjectName)\Test_7zip.pch</PrecompiledHeaderOutputFile>
       <ProgramDataBaseFileName>$(SolutionDir)Output\$(Platform)\$(Configuration)\Intermediate\$(ProjectName)\</ProgramDataBaseFileName>
+      <LanguageStandard>stdcpp20</LanguageStandard>
     </ClCompile>
     <Link>
       <SubSystem>Console</SubSystem>
@@ -186,20 +192,26 @@
   </ItemDefinitionGroup>
   <ItemDefinitionGroup Condition="'$(Configuration)|$(Platform)'=='Development|Win32'">
     <ClCompile>
-      <AdditionalIncludeDirectories>$(SolutionDir)ThirdParty\catch2;%(AdditionalIncludeDirectories)</AdditionalIncludeDirectories>
+      <AdditionalIncludeDirectories>$(SolutionDir)ThirdParty\catch2;$(SolutionDir)CPP\7zip\UI\Common\;%(AdditionalIncludeDirectories)</AdditionalIncludeDirectories>
       <AssemblerListingLocation>$(SolutionDir)Output\$(Platform)\$(Configuration)\Intermediate\$(ProjectName)\</AssemblerListingLocation>
       <ObjectFileName>$(SolutionDir)Output\$(Platform)\$(Configuration)\Intermediate\$(ProjectName)\</ObjectFileName>
       <PrecompiledHeaderOutputFile>$(SolutionDir)Output\$(Platform)\$(Configuration)\Intermediate\$(ProjectName)\Test_7zip.pch</PrecompiledHeaderOutputFile>
       <ProgramDataBaseFileName>$(SolutionDir)Output\$(Platform)\$(Configuration)\Intermediate\$(ProjectName)\</ProgramDataBaseFileName>
+      <LanguageStandard>stdcpp20</LanguageStandard>
+      <Optimization>Disabled</Optimization>
+      <InlineFunctionExpansion>Disabled</InlineFunctionExpansion>
     </ClCompile>
   </ItemDefinitionGroup>
   <ItemDefinitionGroup Condition="'$(Configuration)|$(Platform)'=='Development|x64'">
     <ClCompile>
-      <AdditionalIncludeDirectories>$(SolutionDir)ThirdParty\catch2;%(AdditionalIncludeDirectories)</AdditionalIncludeDirectories>
+      <AdditionalIncludeDirectories>$(SolutionDir)ThirdParty\catch2;$(SolutionDir)CPP\7zip\UI\Common\;%(AdditionalIncludeDirectories)</AdditionalIncludeDirectories>
       <AssemblerListingLocation>$(SolutionDir)Output\$(Platform)\$(Configuration)\Intermediate\$(ProjectName)\</AssemblerListingLocation>
       <ObjectFileName>$(SolutionDir)Output\$(Platform)\$(Configuration)\Intermediate\$(ProjectName)\</ObjectFileName>
       <PrecompiledHeaderOutputFile>$(SolutionDir)Output\$(Platform)\$(Configuration)\Intermediate\$(ProjectName)\Test_7zip.pch</PrecompiledHeaderOutputFile>
       <ProgramDataBaseFileName>$(SolutionDir)Output\$(Platform)\$(Configuration)\Intermediate\$(ProjectName)\</ProgramDataBaseFileName>
+      <LanguageStandard>stdcpp20</LanguageStandard>
+      <Optimization>Disabled</Optimization>
+      <InlineFunctionExpansion>Disabled</InlineFunctionExpansion>
     </ClCompile>
   </ItemDefinitionGroup>
   <ItemGroup>
diff --git a/Test_7zip/test_7zip.cpp b/Test_7zip/test_7zip.cpp
index 414fa3c7..c94b44fb 100644
--- a/Test_7zip/test_7zip.cpp
+++ b/Test_7zip/test_7zip.cpp
@@ -1,16 +1,97 @@
+#include "Windows.h"
+#include "ScannerCommonFunctions.h"
+
 #define CATCH_CONFIG_MAIN
 #include <catch.hpp>
 
+#include <string>
+#include <fstream>
+#include <filesystem>
+
+namespace fs = std::filesystem;
+
+using UnpackFunc = bool (*)(const TCHAR* chAction, const TCHAR* chArchiveName, const TCHAR* chOutputFolderName,
+    const TCHAR* chPassword, const TCHAR* chFileFilter, ScanFileState* pScanFileState);
+using PackFunc = bool (*)(const TCHAR* chAction, const TCHAR* chArchiveName, const TCHAR* chInputFileFolderName,
+    const TCHAR* chPassword, const TCHAR* chFileFilter);
+
+const std::wstring_view k7zipLibName = L"Binaries\\Au7zUnpacker.dll";
+const fs::path kTestDir = fs::temp_directory_path() / "Test7zipFiles";
+const fs::path kUnpackedFile = kTestDir / "Test7zip_unpacked.txt";
+const fs::path kPackedFile = kTestDir / "Test7zip_packed.zip";
+const std::wstring_view kPassword = L"-pabc!@#123ABC";
+const std::string_view kUnpackedContent = "*** TestContent_12345 ***";
+const int kMaxTempFileCount = 10000;
+
+HMODULE g_7zip = nullptr;
+UnpackFunc g_UnpackFunc = nullptr;
+PackFunc g_PackFunc = nullptr;
+
+
+template <typename F>
+void InitFunc(F& function, const char* funcName)
+{
+    if (g_7zip)
+    {
+        function = reinterpret_cast<F>(GetProcAddress(g_7zip, funcName));
+    }
+}
 
 TEST_CASE("Setup")
 {
+    g_7zip = LoadLibrary(k7zipLibName.data());
+    REQUIRE(g_7zip);
+    
+    if (g_7zip)
+    {
+        InitFunc(g_UnpackFunc, "UnMax7zArchive");
+        REQUIRE(g_UnpackFunc);
+
+        InitFunc(g_PackFunc, "Max7zArchive");
+        REQUIRE(g_PackFunc);
+    }
+
+    fs::remove_all(kTestDir);
 }
 
-TEST_CASE("Unzipping the file", "[7zip]")
+TEST_CASE("Zipping/Unzipping the file", "[7zip]")
 {
-    CHECK(true);
+    SECTION("Create source file and write some content there")
+    {
+        fs::create_directory(kTestDir);
+        std::ofstream originalFile(kUnpackedFile.string());
+        REQUIRE(originalFile);
+        originalFile << kUnpackedContent;
+        originalFile.close();
+        REQUIRE(!originalFile.is_open());
+    }
+
+    SECTION("Zipping the file")
+    {
+        bool result = g_PackFunc(L"a", kPackedFile.wstring().data(),
+            kUnpackedFile.wstring().data(), kPassword.data(), nullptr);
+        REQUIRE(result);
+        REQUIRE(fs::exists(kPackedFile));
+        fs::remove(kUnpackedFile);
+    }
+
+    SECTION("Unzipping the file")
+    {
+        std::wstring unpackDirName = L"-o" + kTestDir.wstring();
+        ScanFileState fileState = ScanFileState::E_ScanFileState_None;
+        bool result = g_UnpackFunc(L"x", kPackedFile.wstring().data(),
+            unpackDirName.data(), kPassword.data(), nullptr, &fileState);
+        REQUIRE(result);
+        REQUIRE(fs::exists(kUnpackedFile));
+        std::ifstream unpackedFile(kUnpackedFile);
+        std::stringstream buffer;
+        buffer << unpackedFile.rdbuf();
+        REQUIRE(buffer.str() == kUnpackedContent);
+    }
 }
 
 TEST_CASE("Teardown")
 {
-}
\ No newline at end of file
+    FreeLibrary(g_7zip);
+    fs::remove_all(kTestDir);
+}
