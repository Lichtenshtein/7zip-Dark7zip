From d1a56148882468c8c8b71b44b4d8e9affcff73e3 Mon Sep 17 00:00:00 2001
From: work <q@q.q>
Date: Mon, 6 May 2019 12:29:47 +0200
Subject: [PATCH] Added number for some context menu commands -new menu
 "Extract to Folder or Plain", extracts an archive to a folder if it has more
 than 1 elements in the root -updated FileManager context menu options to be
 able to enable/disable them
 
- added numbers for some context menu commands (**0-Compress, 1-Extract Here, 2-Extract to \***) for faster navigation
- added **"Extract to Folder or Plain"** menu, extracts an archive contents to a folder if it has more than 1 element in the root or extracts the contents directly into the current folder
- added **"Compress to \*"** menu to create separate archives for each selected file (currently it opens multiple compress dialogs, though it should be done using some sort of operations queue)
- updated **FileManager** context menu options to be able to enable/disable the added menu items
---
 CPP/7zip/UI/Explorer/ArchInfo.cpp       | 112 ++++++++++++++++
 CPP/7zip/UI/Explorer/ArchInfo.h         |   8 ++
 CPP/7zip/UI/Explorer/ContextMenu.cpp    | 165 +++++++++++++++---------
 CPP/7zip/UI/Explorer/ContextMenu.h      |   3 +-
 CPP/7zip/UI/Explorer/ContextMenuFlags.h |   2 +
 CPP/7zip/UI/Explorer/makefile           |  47 +++++++
 CPP/7zip/UI/Explorer/resource.h         |   3 +
 CPP/7zip/UI/Explorer/resource2.rc       |  10 +-
 CPP/7zip/UI/FileManager/MenuPage.cpp    |   1 +
 CPP/7zip/UI/FileManager/makefile        |   1 +
 CPP/build-explorer.bat                  |  11 ++
 CPP/build-fm.bat                        |  11 ++
 12 files changed, 310 insertions(+), 64 deletions(-)
 create mode 100644 CPP/7zip/UI/Explorer/ArchInfo.cpp
 create mode 100644 CPP/7zip/UI/Explorer/ArchInfo.h
 create mode 100644 CPP/build-explorer.bat
 create mode 100644 CPP/build-fm.bat

diff --git a/CPP/7zip/UI/Explorer/ArchInfo.cpp b/CPP/7zip/UI/Explorer/ArchInfo.cpp
new file mode 100644
index 0000000..267fbe5
--- /dev/null
+++ b/CPP/7zip/UI/Explorer/ArchInfo.cpp
@@ -0,0 +1,112 @@
+#include "StdAfx.h"
+#include "../../../Common/MyInitGuid.h"
+#include "../Common/ArchiveCommandLine.h"
+
+#include "ArchInfo.h"
+
+// #include <iostream>
+// using namespace std;
+
+
+int getArchRootItems(const UString &fileName) {
+  try {
+    // std::cout << "--getArchRootItems()--\n";
+    
+    CCodecs *codecs = new CCodecs;
+    CExternalCodecs _externalCodecs;
+    _externalCodecs.GetCodecs = codecs;
+    _externalCodecs.GetHashers = codecs;
+    CCodecs::CReleaser codecsReleaser;
+    codecsReleaser.Set(codecs);
+    
+    codecs->CaseSensitive_Change = false;
+    codecs->CaseSensitive = false;
+    if (codecs->Load() != S_OK) {
+      // std::cout << "Codecs Load ERROR\n";
+      return 0;
+    }
+
+    CObjectVector<COpenType> types;
+    CIntVector excludedFormats;
+
+    UStringVector ArchivePathsSorted;
+    ArchivePathsSorted.ClearAndReserve(1);
+    ArchivePathsSorted.AddInReserved(fileName);
+
+    UInt64 numVolumes = 0;
+    UInt64 numArcs = 0;
+    UInt64 totalArcSizes = 0;
+    
+    for (unsigned arcIndex = 0; arcIndex < ArchivePathsSorted.Size(); arcIndex++) {
+      const UString &arcPath = ArchivePathsSorted[arcIndex];
+      UInt64 arcPackSize = 0;
+      
+      NWindows::NFile::NFind::CFileInfo fi;
+      if (!fi.Find(us2fs(arcPath))) {
+        // std::cout << "NO FILE\n";
+        continue;
+      }
+      
+      arcPackSize = fi.Size;
+      totalArcSizes += arcPackSize;
+      
+      COpenOptions options2;
+      #ifndef _SFX
+      CObjectVector<CProperty>* props = new CObjectVector<CProperty>();
+      options2.props = props;
+      #endif
+      options2.codecs = codecs;
+      options2.types = &types;
+      options2.excludedFormats = &excludedFormats;
+      options2.stdInMode = false;
+      options2.stream = NULL;
+      options2.filePath = arcPath;
+      
+      CArchiveLink arcLink;
+      HRESULT result = arcLink.Open(options2);
+      if (result != S_OK) {
+        // std::cout << "===NOK===\n";
+        continue;
+      }
+      else {
+        // std::cout << "===OK===\n";
+      }
+      
+      numArcs++;
+      numVolumes++;
+      
+      numVolumes += arcLink.VolumePaths.Size();
+      totalArcSizes += arcLink.VolumesSize;
+      
+      // std::cout << "numVolumes: " << numVolumes << endl;
+      // std::cout << "totalArcSizes: " << totalArcSizes << endl;
+      // std::cout << "arcLink.VolumePaths.Size: " << arcLink.VolumePaths.Size() << endl;
+      
+      const CArc &arc = arcLink.Arcs.Back();
+      IInArchive *archive = arc.Archive;
+      
+      UInt32 numItems;
+      archive->GetNumberOfItems(&numItems);
+      
+      // std::cout << "===ITEMS=== [" << numItems << "]\n";
+      
+      CReadArcItem item;
+      UInt32 rootItems = 0;
+      for (unsigned i = 0; i < numItems; ++i) {
+        HRESULT res2 = arc.GetItem(i, item);
+        if (res2 == S_OK) {
+          bool inRoot = item.PathParts.Size() == 1;
+          if (inRoot) rootItems++;
+        }
+      }
+      
+      return rootItems;
+    }
+  }
+  catch(...) {
+    return 0;
+  }
+  
+  return 0;
+}
+
diff --git a/CPP/7zip/UI/Explorer/ArchInfo.h b/CPP/7zip/UI/Explorer/ArchInfo.h
new file mode 100644
index 0000000..8e1df76
--- /dev/null
+++ b/CPP/7zip/UI/Explorer/ArchInfo.h
@@ -0,0 +1,8 @@
+#ifndef __ARCHINFO_H
+#define __ARCHINFO_H
+
+#include "../../../Common/MyString.h"
+
+int getArchRootItems(const UString &fileName);
+
+#endif
diff --git a/CPP/7zip/UI/Explorer/ContextMenu.cpp b/CPP/7zip/UI/Explorer/ContextMenu.cpp
index a99ca81..4c8e9e3 100644
--- a/CPP/7zip/UI/Explorer/ContextMenu.cpp
+++ b/CPP/7zip/UI/Explorer/ContextMenu.cpp
@@ -31,4 +31,6 @@
 #include "ContextMenuFlags.h"
 #include "MyMessages.h"
 
+#include "ArchInfo.h"
+
 #include "resource.h"
@@ -276,3 +276,4 @@ static const CContextMenuCommand g_Commands[] =
   CMD_REC( kExtractToSingle,        "ExtractToSingle",        IDS_CONTEXT_EXTRACT_TO_SINGLE),
+  CMD_REC( kExtractToFolderOrPlain,        "ExtractToFolderOrPlain",        IDS_CONTEXT_EXTRACT_TO_FOLDER_OR_PLAIN),
   CMD_REC( kTest,        "Test",        IDS_CONTEXT_TEST),
   CMD_REC( kCompress,           "Compress",           IDS_CONTEXT_COMPRESS),
@@ -917,25 +918,35 @@ STDMETHODIMP CZipContextMenu::QueryContextMenu(HMENU hMenu, UINT indexMenu,
         if ((contextMenuFlags & NContextMenuFlags::kExtractToSingle) != 0)
         {
           // Extract To Single
           CCommandMapItem cmi;
           AddCommand(kExtractToSingle, mainString, cmi);
           /* if archive contain only one folder */
           if (true)
             {
              cmi.Folder = baseFolder;
             }
           else
             {
              cmi.Folder = baseFolder + specFolder;
             }
         MyInsertMenu(popupMenu, subIndex++, currentCommandID++, mainString, bitmap);
        }
+        
+        if ((contextMenuFlags & NContextMenuFlags::kExtractToFolderOrPlain) != 0)
+        {
+          // Extract to Folder or Plain
+          CCommandMapItem cmi;
+          UString s;
+          cmi.Folder = baseFolder;
+          AddCommand(kExtractToFolderOrPlain, s, cmi);
+          MyInsertMenu(popupMenu, subIndex++, currentCommandID++, s, bitmap);
+        }
       }
 
       if ((contextMenuFlags & NContextMenuFlags::kTest) != 0)
       {
         // Test
         CCommandMapItem cmi;
         AddCommand(kTest, mainString, cmi);
         // if (_fileNames.Size() == 16) mainString += "_[16]"; // for debug
         MyInsertMenu(popupMenu, subIndex++, currentCommandID++, mainString, bitmap);
@@ -899,6 +918,34 @@ STDMETHODIMP CZipContextMenu::InvokeCommand(LPCMINVOKECOMMANDINFO commandInfo)
             );
         break;
       }
+      case kExtractToFolderOrPlain:
+      {
+        for (UInt32 i = 0; i < _fileNames.Size(); i++) {
+          const UString &fileName = _fileNames[i];
+          UStringVector arcPaths;
+          arcPaths.Add(fileName);
+          
+          bool toFolder = true;
+          int numItems = getArchRootItems(fileName);
+          if (numItems == 1) toFolder = false;
+          
+          FString folderPrefix;
+          GetOnlyDirPrefix(us2fs(fileName), folderPrefix);
+          UString baseFolder = fs2us(folderPrefix);
+          UString folder = baseFolder;
+          
+          if (toFolder) {
+            NFind::CFileInfo fileInfo;
+            if (!fileInfo.Find(us2fs(fileName))) continue;
+            UString specFolder = GetSubFolderNameForExtract(fs2us(fileInfo.Name));
+            specFolder.Add_PathSepar();
+            folder += specFolder;
+          }
+          
+          ExtractArchives(arcPaths, folder, (cmdID == kExtract), toFolder && _elimDup.Val, _writeZone);
+        }
+        break;
+      }
       case kTest:
       {
         TestArchives(_fileNames);
diff --git a/CPP/7zip/UI/Explorer/ContextMenu.h b/CPP/7zip/UI/Explorer/ContextMenu.h
index 3a0eacc..fbca5ec 100644
--- a/CPP/7zip/UI/Explorer/ContextMenu.h
+++ b/CPP/7zip/UI/Explorer/ContextMenu.h
@@ -81,4 +81,5 @@ class CZipContextMenu:
     kExtractSmart,
     kExtractToSingle,
+    kExtractToFolderOrPlain,
     kTest,
     kCompress,
diff --git a/CPP/7zip/UI/Explorer/ContextMenuFlags.h b/CPP/7zip/UI/Explorer/ContextMenuFlags.h
index f739cdc..d0beb6c 100644
--- a/CPP/7zip/UI/Explorer/ContextMenuFlags.h
+++ b/CPP/7zip/UI/Explorer/ContextMenuFlags.h
@@ -11,18 +11,19 @@ namespace NContextMenuFlags
   const UInt32 kExtractSmart = 1 << 3;
   const UInt32 kExtractToSingle = 1 << 4;
+  const UInt32 kExtractToFolderOrPlain = 1 << 5;
 
-  const UInt32 kTest = 1 << 6;
-  const UInt32 kOpen = 1 << 7;
-  const UInt32 kOpenAs = 1 << 8;
+  const UInt32 kTest = 1 << 7;
+  const UInt32 kOpen = 1 << 8;
+  const UInt32 kOpenAs = 1 << 9;
 
-  const UInt32 kCompress = 1 << 10;
-  const UInt32 kCompressTo7z = 1 << 11;
-  const UInt32 kCompressTo7zWithDate = 1 << 12;
-  const UInt32 kCompressEmail = 1 << 13;
-  const UInt32 kCompressTo7zEmail = 1 << 14;
-  const UInt32 kCompressToZip = 1 << 15;
-  const UInt32 kCompressToZipWithDate = 1 << 16;
-  const UInt32 kCompressToZipEmail = 1 << 17;
+  const UInt32 kCompress = 1 << 11;
+  const UInt32 kCompressTo7z = 1 << 12;
+  const UInt32 kCompressTo7zWithDate = 1 << 13;
+  const UInt32 kCompressEmail = 1 << 14;
+  const UInt32 kCompressTo7zEmail = 1 << 15;
+  const UInt32 kCompressToZip = 1 << 16;
+  const UInt32 kCompressToZipWithDate = 1 << 17;
+  const UInt32 kCompressToZipEmail = 1 << 18;
 
   const UInt32 kCRC_Cascaded = (UInt32)1 << 30;
   const UInt32 kCRC = (UInt32)1 << 31;
diff --git a/CPP/7zip/UI/Explorer/makefile b/CPP/7zip/UI/Explorer/makefile
index 541122a..9a9bf46 100644
--- a/CPP/7zip/UI/Explorer/makefile
+++ b/CPP/7zip/UI/Explorer/makefile
@@ -2,6 +2,7 @@ PROG = 7-zip.dll
 DEF_FILE = Explorer.def
 CFLAGS = $(CFLAGS) \
   -DZ7_LANG \
+  -DZ7_EXTERNAL_CODECS \
 
 !IFDEF UNDER_CE
 LIBS = $(LIBS) Commctrl.lib
@@ -14,6 +15,7 @@ EXPLORER_OBJS = \
   $O\DllExportsExplorer.obj \
   $O\ContextMenu.obj \
   $O\MyMessages.obj \
+  $O\ArchInfo.obj \
 
 COMMON_OBJS = \
   $O\IntToString.obj \
diff --git a/CPP/7zip/UI/Explorer/resource.h b/CPP/7zip/UI/Explorer/resource.h
index 8bb8210..0fe2106 100644
--- a/CPP/7zip/UI/Explorer/resource.h
+++ b/CPP/7zip/UI/Explorer/resource.h
@@ -10,5 +10,6 @@
 #define IDS_CONTEXT_COMPRESS_EMAIL      2331
 #define IDS_CONTEXT_COMPRESS_TO_EMAIL   2332
 
+#define IDS_CONTEXT_EXTRACT_TO_FOLDER_OR_PLAIN  23270
 
 #define IDS_SELECT_FILES                3015
diff --git a/CPP/7zip/UI/Explorer/resource2.rc b/CPP/7zip/UI/Explorer/resource2.rc
index c07148f..10c7633 100644
--- a/CPP/7zip/UI/Explorer/resource2.rc
+++ b/CPP/7zip/UI/Explorer/resource2.rc
@@ -10,7 +10,8 @@ BEGIN
    IDS_CONTEXT_TEST        "Test archive"
    IDS_CONTEXT_EXTRACT_HERE "Extract Here"
    IDS_CONTEXT_EXTRACT_TO  "Extract to {0}"
    IDS_CONTEXT_EXTRACT_SMART "Smart extract"
    IDS_CONTEXT_EXTRACT_TO_SINGLE "Extract to single folder"
+   IDS_CONTEXT_EXTRACT_TO_FOLDER_OR_PLAIN  "Extract to folder or plain"
    IDS_CONTEXT_COMPRESS_TO "Add to {0}"
    IDS_CONTEXT_COMPRESS_EMAIL "Compress and email..."
diff --git a/CPP/7zip/UI/FileManager/MenuPage.cpp b/CPP/7zip/UI/FileManager/MenuPage.cpp
index 4067ad7..b50f91e 100644
--- a/CPP/7zip/UI/FileManager/MenuPage.cpp
+++ b/CPP/7zip/UI/FileManager/MenuPage.cpp
@@ -58,5 +58,6 @@ static const CContextMenuItem kMenuItems[] =
   { IDS_CONTEXT_EXTRACT_SMART, kExtractSmart },
   { IDS_CONTEXT_EXTRACT_TO_SINGLE, kExtractToSingle },
+  { IDS_CONTEXT_EXTRACT_TO_FOLDER_OR_PLAIN, kExtractToFolderOrPlain },
 
   { IDS_CONTEXT_TEST, kTest },
 
diff --git a/CPP/7zip/UI/FileManager/makefile b/CPP/7zip/UI/FileManager/makefile
index 4525d84..7c6f8ca 100644
--- a/CPP/7zip/UI/FileManager/makefile
+++ b/CPP/7zip/UI/FileManager/makefile
@@ -88,7 +88,8 @@ UI_COMMON_OBJS = \
 
 EXPLORER_OBJS = \
   $O\ContextMenu.obj \
   $O\MyMessages.obj \
+  $O\ArchInfo.obj \
   $O\RegistryContextMenu.obj \
 
 GUI_OBJS = \
