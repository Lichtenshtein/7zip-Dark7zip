From ea6457b4ba78a863837cd8afe63f091d55f5abfc Mon Sep 17 00:00:00 2001
From: Nobody <36154203+PopuriAO29@users.noreply.github.com>
Date: Sun, 14 Jan 2024 03:40:09 +0000
Subject: [PATCH]: support-mouse-forward-and-backward
---
diff --git a/CPP/7zip/UI/FileManager/AppState.h b/CPP/7zip/UI/FileManager/AppState.h
index 6630b962..673397ba 100644
--- a/CPP/7zip/UI/FileManager/AppState.h
+++ b/CPP/7zip/UI/FileManager/AppState.h
@@ -3,6 +3,16 @@
 #ifndef ZIP7_INC_APP_STATE_H
 #define ZIP7_INC_APP_STATE_H
 
+// #include <fstream>
+// #include <chrono>
+// #include <iomanip>
+// #include <string>
+// #include <sstream>
+// #include <ctime>
+// #include <Windows.h>
+
+#include "../../../Common/Wildcard.h"
+
 #include "../../../Windows/Synchronization.h"
 
 #include "ViewSettings.h"
@@ -75,10 +85,211 @@ public:
   }
 };
 
+class CPathState
+{
+public:
+  UString selectFile;
+  UString path;
+  unsigned int index;
+};
+
+class CPathStack
+{
+  CObjectVector<CPathState> paths;
+  unsigned int index;
+  bool ignore;
+
+public:
+  
+  void onOpenNewPath(const UString &path) {
+    if (ignore) {
+      return;
+    }
+    if (index < paths.Size() && CompareFileNames(paths[index].path, path) == 0)
+      return;
+    
+    if (paths.IsEmpty()) {
+      index = 0;
+      // writeToFile(UString("input0: ") + path);
+    } else {
+      // writeToFile(UString("curr: ") + paths[index].path);
+      // writeToFile(UString("input: ") + path);
+      // UString temp = UString("index: ");
+      // temp.Add_UInt32(index);
+      // writeToFile(temp);
+      index++;
+    }
+
+    if (index < paths.Size()) {
+      paths.DeleteFrom(index);
+    }
+
+    CPathState state;
+    state.path = path;
+    state.index = index;
+    paths.Add(state);
+  }
+
+  void onSelectChanged(const UString &fileName)
+  {
+    paths[index].selectFile = fileName;
+  }
+
+  // CPathState getBackwardPath()
+  // {
+  //   if (index <= 0)
+  //     return CPathState();
+  //   return paths[index - 1];
+  // }
+
+  // CPathState popBackwardPath()
+  // {
+  //   if (index <= 0)
+  //     return CPathState();
+  //   writeToFile(UString("popBackwardPath: ") + listToStr());
+  //   // ignore = true;
+  //   return paths[--index];
+  // }
+  
+  // CPathState getForwardPath()
+  // {
+  //   if (index + 1 >= paths.Size())
+  //     return CPathState();
+  //   return paths[index + 1];
+  // }
+  
+  // CPathState popForwardPath()
+  // {
+  //   if (index + 1 >= paths.Size())
+  //     return CPathState();
+  //   writeToFile(UString("popForwardPath: ") + listToStr());
+  //   ignore = true;
+  //   return paths[++index];
+  // }
+  
+  CPathState getNavPath(bool forward)
+  {
+    if (forward) {
+      if (index + 1 >= paths.Size())
+        return CPathState();
+      // writeToFile(UString("forward: ") + listToStr());
+      ignore = true;
+      return paths[++index];
+    } else {
+      if (index <= 0)
+        return CPathState();
+      // writeToFile(UString("backward: ") + listToStr());
+      ignore = true;
+      return paths[--index];
+    }
+  }
+
+  void checkNavResult(bool forward, const UString &path) {
+    ignore = false;
+    if (index < 1) {
+      return;
+    }
+    if (index >= paths.Size()) {
+      return;
+    }
+    // UString log = UString("checkNavResult: index: ");
+    // log.Add_UInt32(index);
+    // log += ", path: ";
+    // log += path;
+    // writeToFile(log);
+    if (path == paths[index].path) {
+      return;
+    }
+    unsigned int lastIndex;
+    if (forward) {
+      lastIndex = index - 1;
+    } else {
+      lastIndex = index + 1;
+    }
+    if (path == paths[lastIndex].path) {
+      index--;
+      // log = UString("checkNavResult: update: ");
+      // log.Add_UInt32(index);
+      // writeToFile(log);
+    } else {
+      paths[index].path = path;
+      // writeToFile(UString("checkNavResult: update: ") + path);
+    }
+  }
+  
+  // UString listToStr() {
+  //   UString output;
+  //   for (unsigned int i = 0; i < paths.Size(); i++)
+  //   {
+  //     CPathState state = paths[i];
+  //     output.Add_UInt32(state.index);
+  //     output += ".";
+  //     output += state.path;
+  //     output += " (";
+  //     output += state.selectFile;
+  //     output += ")";
+  //     output.Add_LF();
+  //   }
+  //   output.Add_LF();
+  //   output += "curr: ";
+  //   output.Add_UInt32(index);
+  //   output.Add_LF();
+  //   output += "-----------------------";
+  //   return output;
+  // }
+
+  // void writeToFile(const UString content) {
+  //   // get current time
+  //   auto now = std::chrono::system_clock::now();
+  //   auto now_time_t = std::chrono::system_clock::to_time_t(now);
+    
+  //   std::tm localTime;
+  //   localtime_s(&localTime, &now_time_t);
+
+  //   // format time "YYYY-MM-DD HH:MM:SS"
+  //   char timeStr[100];
+  //   std::strftime(timeStr, sizeof(timeStr), "%Y-%m-%d %H:%M:%S", &localTime);
+
+  //   // get micro second
+  //   auto now_us = std::chrono::duration_cast<std::chrono::microseconds>(now.time_since_epoch()) % 1000000;
+
+  //   // add micro second to time
+  //   std::string finalTimeStr = std::string(timeStr) + "." + std::to_string(now_us.count());
+
+  //   // open file
+  //   std::ofstream outFile("7z.log", std::ios::app);
+
+  //   if (outFile.is_open()) {
+  //       outFile.write(finalTimeStr.c_str(), finalTimeStr.size());
+  //       outFile.put(' ');
+  //       const std::wstring message = content.Ptr();
+  //       // std::string narrowMessage(message.begin(), message.end());
+  //       std::string narrowMessage = wstringToString(message);
+  //       outFile.write(narrowMessage.c_str(), narrowMessage.size());
+  //       outFile.put('\n');
+  //       outFile.close();
+  //       // std::cout << "Message written to file successfully." << std::endl;
+  //   } else {
+  //       // std::cerr << "Unable to open file for writing." << std::endl;
+  //   }
+  // }
+
+  // std::string wstringToString(const std::wstring& wstr) {
+  //   // get buffer size
+  //   int bufferSize = WideCharToMultiByte(CP_UTF8, 0, wstr.c_str(), -1, nullptr, 0, nullptr, nullptr);
+  //   // allocate buffer
+  //   std::string str(bufferSize, 0);
+  //   WideCharToMultiByte(CP_UTF8, 0, wstr.c_str(), -1, &str[0], bufferSize, nullptr, nullptr);
+  //   return str;
+  // }
+};
+
+
 struct CAppState
 {
   CFastFolders FastFolders;
   CFolderHistory FolderHistory;
+  CPathStack PathStack;
 
   void Save()
   {
diff --git a/CPP/7zip/UI/FileManager/Panel.cpp b/CPP/7zip/UI/FileManager/Panel.cpp
index 84bd88c5..82fdb743 100644
--- a/CPP/7zip/UI/FileManager/Panel.cpp
+++ b/CPP/7zip/UI/FileManager/Panel.cpp
@@ -160,7 +160,27 @@ LRESULT CPanel::OnMessage(UINT message, WPARAM wParam, LPARAM lParam)
 
 LRESULT CMyListView::OnMessage(UINT message, WPARAM wParam, LPARAM lParam)
 {
-  if (message == WM_CHAR)
+  if (message == WM_XBUTTONUP) {
+    UINT button = GET_XBUTTON_WPARAM(wParam);
+    if (button == XBUTTON1 || button == XBUTTON2) {
+      bool forward = button == XBUTTON2;
+      // MessageBoxW(_window, L"XBUTTON2", L"7-Zip", MB_ICONERROR);
+      CPathState state = g_App.AppState.PathStack.getNavPath(forward);
+      if (!state.path.IsEmpty()) {
+        // MessageBoxW(_window, result.selectFile, L"7-Zip", MB_ICONERROR);
+        g_App.GetFocusedPanel().BindAndRefreshAndSelect(state.path, state.selectFile);
+        g_App.AppState.PathStack.checkNavResult(forward, g_App.GetFocusedPanel()._currentFolderPrefix);
+        // HRESULT result =
+        // if (result != S_OK) {
+        //   // g_App.AppState.PathStack.popForwardPath();
+        //   g_App.AppState.PathStack.writeToFile(UString("failed"));
+        // }
+        //  else {
+        //   MessageBoxW(_window, L"failed", L"7-Zip", MB_ICONERROR);
+        // }
+      }
+    }
+  } else if (message == WM_CHAR)
   {
     UINT scanCode = (UINT)((lParam >> 16) & 0xFF);
     bool extended = ((lParam & 0x1000000) != 0);
diff --git a/CPP/7zip/UI/FileManager/Panel.h b/CPP/7zip/UI/FileManager/Panel.h
index 9ef09265..82486570 100644
--- a/CPP/7zip/UI/FileManager/Panel.h
+++ b/CPP/7zip/UI/FileManager/Panel.h
@@ -564,6 +564,7 @@ public:
   void SetToRootFolder();
   HRESULT BindToPath(const UString &fullPath, const UString &arcFormat, COpenResult &openRes); // can be prefix
   HRESULT BindToPathAndRefresh(const UString &path);
+  HRESULT BindAndRefreshAndSelect(const UString &path, const UString &focusedName);
   void OpenDrivesFolder();
   
   void SetBookmark(unsigned index);
diff --git a/CPP/7zip/UI/FileManager/PanelFolderChange.cpp b/CPP/7zip/UI/FileManager/PanelFolderChange.cpp
index b0fb53e1..d55c83b7 100644
--- a/CPP/7zip/UI/FileManager/PanelFolderChange.cpp
+++ b/CPP/7zip/UI/FileManager/PanelFolderChange.cpp
@@ -332,6 +332,33 @@ HRESULT CPanel::BindToPathAndRefresh(const UString &path)
   return res;
 }
 
+HRESULT CPanel::BindAndRefreshAndSelect(const UString &path, const UString &focusedName)
+{
+  CDisableTimerProcessing disableTimerProcessing(*this);
+  CDisableNotify disableNotify(*this);
+  COpenResult openRes;
+  UString s = path;
+  
+  #ifdef _WIN32
+    if (!s.IsEmpty() && s[0] == '\"' && s.Back() == '\"')
+    {
+      s.DeleteBack();
+      s.Delete(0);
+    }
+  #endif
+
+  HRESULT res = BindToPath(s, UString(), openRes);
+  if (res == S_OK) {
+    CSelectedState state;
+    state.FocusedName = focusedName;
+    state.FocusedName_Defined = true;
+    RefreshListCtrl(state);
+  } else {
+    RefreshListCtrl();
+  }
+  return res;
+}
+
 void CPanel::SetBookmark(unsigned index)
 {
   _appState->FastFolders.SetString(index, _currentFolderPrefix);
@@ -407,6 +434,7 @@ void CPanel::LoadFullPathAndShow()
 {
   LoadFullPath();
   _appState->FolderHistory.AddString(_currentFolderPrefix);
+  _appState->PathStack.onOpenNewPath(_currentFolderPrefix);
 
   _headerComboBox.SetText(_currentFolderPrefix);
 
diff --git a/CPP/7zip/UI/FileManager/PanelListNotify.cpp b/CPP/7zip/UI/FileManager/PanelListNotify.cpp
index a17d8c04..14a03f61 100644
--- a/CPP/7zip/UI/FileManager/PanelListNotify.cpp
+++ b/CPP/7zip/UI/FileManager/PanelListNotify.cpp
@@ -854,6 +854,13 @@ void CPanel::Refresh_StatusBar()
             break;
         }
       }
+      if (_folder->GetProperty(realIndex, kpidName, &prop) == S_OK)
+      {
+        UString fileName;
+        ConvertPropertyToString2(fileName, prop, kpidName, 9);
+        g_App.AppState.PathStack.onSelectChanged(fileName);
+        // MessageBoxW(_window, fileName, L"7-Zip", MB_ICONERROR);
+      }
     }
   }
   _statusBar.SetText(2, sizeString);
