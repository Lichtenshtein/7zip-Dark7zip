From fa9bdf91d543f128f0c89910e08f3f61e013cc39 Mon Sep 17 00:00:00 2001
From: mortalis13 <rh> & Lichtenshtein
Date: Thu, 10 Sep 2020 17:18:12 +0200
Subject: [PATCH] Added menu option to compress each selected file/folder to a
 separate zip/7z

---
 CPP/7zip/UI/Explorer/ContextMenu.cpp    | 39 +++++++++++++++++++++++++
 CPP/7zip/UI/Explorer/ContextMenu.h      |  1 +
 CPP/7zip/UI/Explorer/ContextMenuFlags.h |  1 +
 CPP/7zip/UI/Explorer/resource.h         |  3 +-
 CPP/7zip/UI/Explorer/resource2.rc       |  1 +
 CPP/7zip/UI/FileManager/MenuPage.cpp    |  1 +
 README.md                               | 11 ++++---
 7 files changed, 52 insertions(+), 5 deletions(-)

diff --git a/CPP/7zip/UI/Explorer/ContextMenu.cpp b/CPP/7zip/UI/Explorer/ContextMenu.cpp
index 4c8e9e3..67e7d58 100644
--- a/CPP/7zip/UI/Explorer/ContextMenu.cpp
+++ b/CPP/7zip/UI/Explorer/ContextMenu.cpp
@@ -283,4 +283,6 @@ static const CContextMenuCommand g_Commands[] =
   CMD_REC( kCompressToZipWithDate,      "CompressToZip",      IDS_CONTEXT_COMPRESS_TO),
-  CMD_REC( kCompressToZipEmail, "CompressToZipEmail", IDS_CONTEXT_COMPRESS_TO_EMAIL)
+  CMD_REC( kCompressToZipEmail, "CompressToZipEmail", IDS_CONTEXT_COMPRESS_TO_EMAIL),
+  CMD_REC( kCompressToZipSeparate, "CompressToZipSeparate", IDS_CONTEXT_COMPRESS_TO_ZIP_SEPARATE),
+  CMD_REC( kCompressTo7zSeparate, "CompressTo7zSeparate", IDS_CONTEXT_COMPRESS_TO_7Z_SEPARATE)
 };
 
@@ -940,17 +940,32 @@ STDMETHODIMP CZipContextMenu::QueryContextMenu(HMENU hMenu, UINT indexMenu,
       // CompressTo7z With Datetime
       CCommandMapItem cmi2;
       UString s2;
       if (_dropMode)
         cmi2.Folder = _dropPath;
       else
         cmi2.Folder = fs2us(folderPrefix);
       cmi2.ArcName = arcName_dt_7z;
       cmi2.ArcType = "7z";
       AddCommand(kCompressTo7zWithDate, s2, cmi2);
       MyFormatNew_ReducedName(s2, arcName_dt_7z_Show);
       Set_UserString_in_LastCommand(s2);
       MyInsertMenu(popupMenu, subIndex++, currentCommandID++, s2, bitmap);
     }
+    // CompressToSeparate 7z
+    if (contextMenuFlags & NContextMenuFlags::kCompressTo7zSeparate)
+    {
+      CCommandMapItem cmi;
+      UString s3;
+      if (_dropMode)
+        cmi.Folder = _dropPath;
+      else
+        cmi.Folder = fs2us(folderPrefix);
+      cmi.ArcName = arcName_7z;
+      cmi.ArcType = "7z";
+      AddCommand(kCompressTo7zSeparate, s3, cmi);
+      MyFormatNew_ReducedName(s3, arcName_7z_Show);
+      MyInsertMenu(popupMenu, subIndex++, currentCommandID++, s3, bitmap);
+    }
 
     #ifdef EMAIL_SUPPORT
     // CompressTo7zEmail
@@ -991,17 +991,33 @@ STDMETHODIMP CZipContextMenu::QueryContextMenu(HMENU hMenu, UINT indexMenu,
       // CompressToZip With Datetime
       CCommandMapItem cmi2;
       UString s2;
       if (_dropMode)
         cmi2.Folder = _dropPath;
       else
         cmi2.Folder = fs2us(folderPrefix);
       cmi2.ArcName = arcName_dt_zip;
       cmi2.ArcType = "zip";
       AddCommand(kCompressToZipWithDate, s2, cmi2);
       MyFormatNew_ReducedName(s2, arcName_dt_zip_Show);
       Set_UserString_in_LastCommand(s2);
       MyInsertMenu(popupMenu, subIndex++, currentCommandID++, s2, bitmap);
     }
+ 
+    // CompressToSeparate
+    if (contextMenuFlags & NContextMenuFlags::kCompressToZipSeparate)
+    {
+      CCommandMapItem cmi;
+      UString s3;
+      if (_dropMode)
+        cmi.Folder = _dropPath;
+      else
+        cmi.Folder = fs2us(folderPrefix);
+      cmi.ArcName = arcName_zip;
+      cmi.ArcType = "zip";
+      AddCommand(kCompressToZipSeparate, s3, cmi);
+      MyFormatNew_ReducedName(s3, arcName_zip_Show);
+      MyInsertMenu(popupMenu, subIndex++, currentCommandID++, s3, bitmap);
+    }
 
     #ifdef EMAIL_SUPPORT
     // CompressToZipEmail
@@ -1339,5 +1339,47 @@ STDMETHODIMP CZipContextMenu::InvokeCommand(LPCMINVOKECOMMANDINFO commandInfo)
         break;
       }
+      case kCompressTo7zSeparate:
+      {
+        for (UInt32 i = 0; i < _fileNames.Size(); i++) {
+          UString fileName = _fileNames[i];
+          UStringVector filePaths;
+          filePaths.Add(fileName);
+          
+          UString arcName = CreateArchiveName(
+              filePaths,
+              false, // isHash
+              NULL, // fi0
+              arcName);
+          const char *postfix = NULL;
+            postfix = ".7z";
+            arcName += postfix;
+          
+          CompressFiles(cmi.Folder, arcName, cmi.ArcType, false,
+            filePaths, false, false, false);
+        }
+        break;
+      }
+      case kCompressToZipSeparate:
+      {
+        for (UInt32 i = 0; i < _fileNames.Size(); i++) {
+          UString fileName = _fileNames[i];
+          UStringVector filePaths;
+          filePaths.Add(fileName);
+          
+          UString arcName = CreateArchiveName(
+              filePaths,
+              false, // isHash
+              NULL, // fi0
+              arcName);
+          const char *postfix = NULL;
+            postfix = ".zip";
+            arcName += postfix;
+          
+          CompressFiles(cmi.Folder, arcName, cmi.ArcType, false,
+            filePaths, false, false, false);
+        }
+        break;
+      }
 
       case kHash_CRC32:
       case kHash_CRC64:
diff --git a/CPP/7zip/UI/Explorer/ContextMenu.h b/CPP/7zip/UI/Explorer/ContextMenu.h
index fbca5ec..de3e372 100644
--- a/CPP/7zip/UI/Explorer/ContextMenu.h
+++ b/CPP/7zip/UI/Explorer/ContextMenu.h
@@ -85,8 +85,10 @@ class CZipContextMenu:
     kCompressEmail,
     kCompressTo7z,
     kCompressTo7zWithDate,
+    kCompressTo7zSeparate,
     kCompressTo7zEmail,
     kCompressToZip,
     kCompressToZipWithDate,
+    kCompressToZipSeparate,
     kCompressToZipEmail,
     kHash_CRC32,
diff --git a/CPP/7zip/UI/Explorer/ContextMenuFlags.h b/CPP/7zip/UI/Explorer/ContextMenuFlags.h
index d0beb6c..a9e42e6 100644
--- a/CPP/7zip/UI/Explorer/ContextMenuFlags.h
+++ b/CPP/7zip/UI/Explorer/ContextMenuFlags.h
@@ -19,11 +19,13 @@ namespace NContextMenuFlags
-  const UInt32 kCompress = 1 << 10;
-  const UInt32 kCompressTo7z = 1 << 11;
-  const UInt32 kCompressTo7zWithDate = 1 << 12;
-  const UInt32 kCompressEmail = 1 << 13;
-  const UInt32 kCompressTo7zEmail = 1 << 14;
-  const UInt32 kCompressToZip = 1 << 15;
-  const UInt32 kCompressToZipWithDate = 1 << 16;
-  const UInt32 kCompressToZipEmail = 1 << 17;
+  const UInt32 kCompress = 1 << 10;
+  const UInt32 kCompressTo7z = 1 << 11;
+  const UInt32 kCompressTo7zWithDate = 1 << 12;
+  const UInt32 kCompressTo7zSeparate = 1 << 13;
+  const UInt32 kCompressEmail = 1 << 14;
+  const UInt32 kCompressTo7zEmail = 1 << 15;
+  const UInt32 kCompressToZip = 1 << 16;
+  const UInt32 kCompressToZipWithDate = 1 << 17;
+  const UInt32 kCompressToZipSeparate = 1 << 18;
+  const UInt32 kCompressToZipEmail = 1 << 19;
 
   const UInt32 kCRC_Cascaded = (UInt32)1 << 30;
   const UInt32 kCRC = (UInt32)1 << 31;
diff --git a/CPP/7zip/UI/Explorer/resource.h b/CPP/7zip/UI/Explorer/resource.h
index 0fe2106..0d35f98 100644
--- a/CPP/7zip/UI/Explorer/resource.h
+++ b/CPP/7zip/UI/Explorer/resource.h
@@ -11,4 +11,6 @@
 #define IDS_CONTEXT_COMPRESS_TO_EMAIL   2332
 
+#define IDS_CONTEXT_COMPRESS_TO_ZIP_SEPARATE           23271
+#define IDS_CONTEXT_COMPRESS_TO_7Z_SEPARATE           23272
 
 #define IDS_SELECT_FILES                3015
diff --git a/CPP/7zip/UI/Explorer/resource2.rc b/CPP/7zip/UI/Explorer/resource2.rc
index 61fd3c1..c732d5b 100644
--- a/CPP/7zip/UI/Explorer/resource2.rc
+++ b/CPP/7zip/UI/Explorer/resource2.rc
@@ -15,3 +15,5 @@ BEGIN
   IDS_CONTEXT_COMPRESS_TO "Add to {0}"
+  IDS_CONTEXT_COMPRESS_TO_7Z_SEPARATE    "Compress to separate .7z"
+  IDS_CONTEXT_COMPRESS_TO_ZIP_SEPARATE    "Compress to separate .zip"
   IDS_CONTEXT_COMPRESS_EMAIL "Compress and email..."
   IDS_CONTEXT_COMPRESS_TO_EMAIL "Compress to {0} and email"
diff --git a/CPP/7zip/UI/FileManager/MenuPage.cpp b/CPP/7zip/UI/FileManager/MenuPage.cpp
index 99ddb33..abc900e 100644
--- a/CPP/7zip/UI/FileManager/MenuPage.cpp
+++ b/CPP/7zip/UI/FileManager/MenuPage.cpp
@@ -61,8 +61,10 @@ static const CContextMenuItem kMenuItems[] =
   { IDS_CONTEXT_TEST, kTest },
 
   { IDS_CONTEXT_COMPRESS, kCompress },
   { IDS_CONTEXT_COMPRESS_TO, kCompressTo7z },
   { IDS_CONTEXT_COMPRESS_TO, kCompressTo7zWithDate },
+  { IDS_CONTEXT_COMPRESS_TO_7Z_SEPARATE, kCompressTo7zSeparate },
   { IDS_CONTEXT_COMPRESS_TO, kCompressToZip },
   { IDS_CONTEXT_COMPRESS_TO, kCompressToZipWithDate },
+  { IDS_CONTEXT_COMPRESS_TO_ZIP_SEPARATE, kCompressToZipSeparate },
 
