From 3bc92f9e5b5f3374dc44c691e17b42917be270ac Mon Sep 17 00:00:00 2001
From: Florin9doi <Florin9doi@users.noreply.github.com>
Date: Sun, 2 Jul 2023 12:03:26 +0300
Subject: [PATCH 1/3] Support for Backward/forward navigation using MB4+5 and
 toolbar buttons

---
 CPP/7zip/UI/FileManager/App.cpp               |  15 ++++++
 CPP/7zip/UI/FileManager/AppState.h            |   9 +++-
 CPP/7zip/UI/FileManager/FM.cpp                |  16 ++++++-
 CPP/7zip/UI/FileManager/Navibar.bmp           | Bin 0 -> 934 bytes
 CPP/7zip/UI/FileManager/Panel.cpp             |  45 ++++++++++++++++--
 CPP/7zip/UI/FileManager/Panel.h               |  19 +++++++-
 CPP/7zip/UI/FileManager/PanelFolderChange.cpp |  33 +++++++++++++
 CPP/7zip/UI/FileManager/PanelItems.cpp        |   6 ++-
 CPP/7zip/UI/FileManager/resource.h            |   7 +++
 CPP/7zip/UI/FileManager/resource.rc           |   1 +
 10 files changed, 142 insertions(+), 9 deletions(-)
 create mode 100644 CPP/7zip/UI/FileManager/Navibar.bmp

diff --git a/CPP/7zip/UI/FileManager/App.cpp b/CPP/7zip/UI/FileManager/App.cpp
index 3461c922..63aebd31 100644
--- a/CPP/7zip/UI/FileManager/App.cpp
+++ b/CPP/7zip/UI/FileManager/App.cpp
@@ -993,6 +993,21 @@ void CFolderHistory::Normalize()
 void CFolderHistory::AddString(const UString &s)
 {
   NSynchronization::CCriticalSectionLock lock(_criticalSection);
   AddUniqueStringToHead(Strings, s);
   Normalize();
 }
+
+void CFolderHistory::Push(const UString &s)
+{
+  NSynchronization::CCriticalSectionLock lock(_criticalSection);
+  Strings.Insert(0, s);
+  Normalize();
+}
+
+const UString CFolderHistory::Pop()
+{
+  NSynchronization::CCriticalSectionLock lock(_criticalSection);
+  UString ret = Strings.Front();
+  Strings.Delete(0);
+  return ret;
+}
diff --git a/CPP/7zip/UI/FileManager/AppState.h b/CPP/7zip/UI/FileManager/AppState.h
index 6630b962..8b299f67 100644
--- a/CPP/7zip/UI/FileManager/AppState.h
+++ b/CPP/7zip/UI/FileManager/AppState.h
@@ -49,13 +49,20 @@ public:
   
   void GetList(UStringVector &foldersHistory)
   {
     NWindows::NSynchronization::CCriticalSectionLock lock(_criticalSection);
     foldersHistory = Strings;
   }
-  
+
+  int Size()
+  {
+    return Strings.Size();
+  }
+
+  void Push(const UString& s);
+  const UString Pop();
   void AddString(const UString &s);
 
   void RemoveAll()
   {
     NWindows::NSynchronization::CCriticalSectionLock lock(_criticalSection);
     Strings.Clear();
diff --git a/CPP/7zip/UI/FileManager/FM.cpp b/CPP/7zip/UI/FileManager/FM.cpp
index 13189a76..d094f721 100644
--- a/CPP/7zip/UI/FileManager/FM.cpp
+++ b/CPP/7zip/UI/FileManager/FM.cpp
@@ -956,13 +956,27 @@ LRESULT CALLBACK WndProc(HWND hWnd, UINT message, WPARAM wParam, LPARAM lParam)
     
     case WM_LBUTTONUP:
     {
       ::ReleaseCapture();
       break;
     }
-    
+
+    case WM_APPCOMMAND:
+    {
+      switch (GET_APPCOMMAND_LPARAM(lParam))
+      {
+        case APPCOMMAND_BROWSER_BACKWARD:
+          g_App.Panels[g_App.LastFocusedPanel].MoveBackward();
+          return 0;
+        case APPCOMMAND_BROWSER_FORWARD:
+          g_App.Panels[g_App.LastFocusedPanel].MoveForward();
+          return 0;
+      }
+      break;
+    }
+
     case WM_MOUSEMOVE:
     {
       if ((wParam & MK_LBUTTON) != 0 && ::GetCapture() == hWnd)
       {
         g_Splitter.SetPos(hWnd, g_StartCaptureSplitterPos +
             (short)LOWORD(lParam) - g_StartCaptureMousePos);
diff --git a/CPP/7zip/UI/FileManager/Navibar.bmp b/CPP/7zip/UI/FileManager/Navibar.bmp
new file mode 100644
index 0000000000000000000000000000000000000000..b649d1af255b2c7e4aa9ab9478bbb4f422c16b89
GIT binary patch
literal 934
zcmbu5Jr2S!422z)8IiECCKF?&+<*bGaHpPzi*T^=9LG-5A~9ge`FZ*DZ0GiTO;qBJ
z^@@BTFGxoRtP<}d5hp90E3GSU3+J-%`LCFA&c6)2_h(~fI}L}Bk}+;%Oz#;#GIs44
z7e^+jQOATWqxZ(R6fq-WCLT8Dpq(}*q=+FAGszA?iW}on4Lm@UkdBNoy=TNo8MEO6
z#-|g1rZP?MnFxZLPiG#5%&2Ez<GcrhDa5hPMQyHHi3ccE@jtNZBB;&?S4Hgqx$0(v
s%3GgeFP&B!v@zByU6um18$LVn*0tKOk=f|meh-H4-&ENYQ2E>b0X<$Wr~m)}

literal 0
HcmV?d00001

diff --git a/CPP/7zip/UI/FileManager/Panel.cpp b/CPP/7zip/UI/FileManager/Panel.cpp
index 72b72c65..39fbe3a1 100644
--- a/CPP/7zip/UI/FileManager/Panel.cpp
+++ b/CPP/7zip/UI/FileManager/Panel.cpp
@@ -146,12 +146,23 @@ LRESULT CPanel::OnMessage(UINT message, WPARAM wParam, LPARAM lParam)
       OnTimer();
       return 0;
     case WM_CONTEXTMENU:
       if (OnContextMenu(HANDLE(wParam), GET_X_LPARAM(lParam), GET_Y_LPARAM(lParam)))
         return 0;
       break;
+    case WM_APPCOMMAND:
+      switch(GET_APPCOMMAND_LPARAM(lParam))
+      {
+        case APPCOMMAND_BROWSER_BACKWARD:
+          MoveBackward();
+          return 0;
+        case APPCOMMAND_BROWSER_FORWARD:
+          MoveForward();
+          return 0;
+      }
+      break;
     /*
     case WM_DROPFILES:
       CompressDropFiles(HDROP(wParam));
       return 0;
     */
   }
@@ -441,13 +452,15 @@ bool CPanel::OnCreate(CREATESTRUCT * /* createStruct */)
   icex.dwICC  = ICC_BAR_CLASSES;
   InitCommonControlsEx(&icex);
 
   const TBBUTTON tbb[] =
   {
     // {0, 0, TBSTATE_ENABLED, BTNS_SEP, 0L, 0},
-    {VIEW_PARENTFOLDER, kParentFolderID, TBSTATE_ENABLED, BTNS_BUTTON, { 0, 0 }, 0, 0 },
+    {NAVIBAR_BACK, kMoveBackwardID, TBSTATE_ENABLED, TBSTATE_INDETERMINATE, { 0, 0 }, 0, 0 },
+    {NAVIBAR_FORWARD, kMoveForwardID, TBSTATE_ENABLED, TBSTATE_INDETERMINATE, { 0, 0 }, 0, 0 },
+    {NAVIBAR_UP, kParentFolderID, TBSTATE_ENABLED, BTNS_BUTTON, { 0, 0 }, 0, 0 },
     // {0, 0, TBSTATE_ENABLED, BTNS_SEP, 0L, 0},
     // {VIEW_NEWFOLDER, kCreateFolderID, TBSTATE_ENABLED, BTNS_BUTTON, 0L, 0},
   };
 
   #ifndef UNDER_CE
   if (g_ComCtl32Version >= MAKELONG(71, 4))
@@ -482,18 +495,28 @@ bool CPanel::OnCreate(CREATESTRUCT * /* createStruct */)
       | CCS_NODIVIDER
       | CCS_NORESIZE
       | TBSTYLE_FLAT
       ;
   }
 
+  _headerImageList.Create(24, 24, ILC_MASK | ILC_COLOR32, 0, 0);
+  HBITMAP b = ::LoadBitmap(g_hInstance, MAKEINTRESOURCE(IDB_NAVIBAR));
+  if (b)
+  {
+    _headerImageList.AddMasked(b, RGB(255, 0, 255));
+    ::DeleteObject(b);
+  }
+
   _headerToolBar.Attach(::CreateToolbarEx ((*this), toolbarStyle,
-      _baseID + 2, 11,
-      (HINSTANCE)HINST_COMMCTRL,
-      IDB_VIEW_SMALL_COLOR,
+      _baseID + 2, NAVIBAR_COUNT,
+      NULL,
+      IDB_NAVIBAR,
       (LPCTBBUTTON)&tbb, Z7_ARRAY_SIZE(tbb),
-      0, 0, 0, 0, sizeof (TBBUTTON)));
+      24, 24, 24, 24, sizeof (TBBUTTON)));
+
+  _headerToolBar.SetImageList(0, _headerImageList);
 
   #ifndef UNDER_CE
   // Load ComboBoxEx class
   icex.dwSize = sizeof(INITCOMMONCONTROLSEX);
   icex.dwICC = ICC_USEREX_CLASSES;
   InitCommonControlsEx(&icex);
@@ -728,12 +751,24 @@ bool CPanel::OnNotify(UINT /* controlID */, LPNMHDR header, LRESULT &result)
   }
   return false;
 }
 
 bool CPanel::OnCommand(unsigned code, unsigned itemID, LPARAM lParam, LRESULT &result)
 {
+  if (itemID == kMoveBackwardID)
+  {
+    MoveBackward();
+    result = 0;
+    return true;
+  }
+  if (itemID == kMoveForwardID)
+  {
+    MoveForward();
+    result = 0;
+    return true;
+  }
   if (itemID == kParentFolderID)
   {
     OpenParentFolder();
     result = 0;
     return true;
   }
diff --git a/CPP/7zip/UI/FileManager/Panel.h b/CPP/7zip/UI/FileManager/Panel.h
index e512cadf..a35ac01d 100644
--- a/CPP/7zip/UI/FileManager/Panel.h
+++ b/CPP/7zip/UI/FileManager/Panel.h
@@ -23,12 +23,13 @@
 #include "../../../Windows/Handle.h"
 #include "../../../Windows/PropVariantConv.h"
 #include "../../../Windows/Synchronization.h"
 
 #include "../../../Windows/Control/ComboBox.h"
 #include "../../../Windows/Control/Edit.h"
+#include "../../../Windows/Control/ImageList.h"
 #include "../../../Windows/Control/ListView.h"
 #include "../../../Windows/Control/ReBar.h"
 #include "../../../Windows/Control/Static.h"
 #include "../../../Windows/Control/StatusBar.h"
 #include "../../../Windows/Control/ToolBar.h"
 #include "../../../Windows/Control/Window2.h"
@@ -46,13 +47,18 @@
 #ifdef UNDER_CE
 #define NON_CE_VAR(_v_)
 #else
 #define NON_CE_VAR(_v_) _v_
 #endif
 
-const int kParentFolderID = 100;
+enum
+{
+  kMoveBackwardID = 100,
+  kMoveForwardID,
+  kParentFolderID
+};
 
 const unsigned kParentIndex = (unsigned)(int)-1;
 const UInt32 kParentIndex_UInt32 = (UInt32)(Int32)kParentIndex;
 
 #if !defined(_WIN32) || defined(UNDER_CE)
 #define ROOT_FS_FOLDER L"\\"
@@ -387,12 +393,13 @@ private:
 
   // CRecordVector<PROPID> m_ColumnsPropIDs;
 
 public:
   NWindows::NControl::CReBar _headerReBar;
   NWindows::NControl::CToolBar _headerToolBar;
+  NWindows::NControl::CImageList _headerImageList;
   NWindows::NControl::
     #ifdef UNDER_CE
     CComboBox
     #else
     CComboBoxEx
     #endif
@@ -477,12 +484,13 @@ public:
   // bool _showNtfsStrems_ModeForDisk;
   // bool _showNtfsStrems_ModeForArc;
 
   bool _dontShowMode;
 
 
+  UString _lastFolderPrefix;
   UString _currentFolderPrefix;
   
   CObjectVector<CFolderLink> _parentFolders;
   NWindows::NDLL::CLibrary _library;
   
   CMyComPtr<IFolderFolder> _folder;
@@ -490,12 +498,21 @@ public:
   CMyComPtr<IFolderCompare> _folderCompare;
   CMyComPtr<IFolderGetItemName> _folderGetItemName;
   CMyComPtr<IArchiveGetRawProps> _folderRawProps;
   CMyComPtr<IFolderAltStreams> _folderAltStreams;
   CMyComPtr<IFolderOperations> _folderOperations;
 
+  CFolderHistory _backwardHistory;
+  CFolderHistory _forwardHistory;
+  bool _IsNaviTriggered;
+  bool IsBackwardAvailable() { return _backwardHistory.Size() > 0; }
+  bool IsForwardAvailable() { return _forwardHistory.Size() > 0; }
+  void MoveBackward();
+  void MoveForward();
+  void UpdateNaviHistory();
+
 
   // for drag and drop highliting
   int m_DropHighlighted_SelectionIndex;
   // int m_SubFolderIndex;      // realIndex of item in m_Panel list (if drop cursor to that item)
   UString m_DropHighlighted_SubFolderName;   // name of folder in m_Panel list (if drop cursor to that folder)
 
diff --git a/CPP/7zip/UI/FileManager/PanelFolderChange.cpp b/CPP/7zip/UI/FileManager/PanelFolderChange.cpp
index a13b88d0..f78b5a6d 100644
--- a/CPP/7zip/UI/FileManager/PanelFolderChange.cpp
+++ b/CPP/7zip/UI/FileManager/PanelFolderChange.cpp
@@ -828,12 +828,45 @@ void CPanel::OpenRootFolder()
   SetCurrentPathText();
   RefreshListCtrl(UString(), 0, UStringVector());
   _listView.EnsureVisible(_listView.GetFocusedItem(), false);
   */
 }
 
+void CPanel::MoveBackward()
+{
+  if (_backwardHistory.Size() > 0)
+  {
+    _IsNaviTriggered = true;
+    _forwardHistory.Push(_currentFolderPrefix);
+    UString path = _backwardHistory.Pop();
+    BindToPathAndRefresh(path);
+  }
+}
+
+void CPanel::MoveForward()
+{
+  if (_forwardHistory.Size() > 0)
+  {
+    _IsNaviTriggered = true;
+    _backwardHistory.Push(_currentFolderPrefix);
+    UString path = _forwardHistory.Pop();
+    BindToPathAndRefresh(path);
+  }
+}
+
+void CPanel::UpdateNaviHistory()
+{
+  if (_lastFolderPrefix != _currentFolderPrefix && PanelCreated && !_IsNaviTriggered)
+  {
+    _backwardHistory.Push(_lastFolderPrefix);
+    _forwardHistory.RemoveAll();
+  }
+  _lastFolderPrefix = _currentFolderPrefix;
+  _IsNaviTriggered = false;
+}
+
 void CPanel::OpenDrivesFolder()
 {
   CloseOpenFolders();
   #ifdef UNDER_CE
   NFsFolder::CFSFolder *folderSpec = new NFsFolder::CFSFolder;
   SetNewFolder(folderSpec);
diff --git a/CPP/7zip/UI/FileManager/PanelItems.cpp b/CPP/7zip/UI/FileManager/PanelItems.cpp
index 0cb33d8b..a346d8b0 100644
--- a/CPP/7zip/UI/FileManager/PanelItems.cpp
+++ b/CPP/7zip/UI/FileManager/PanelItems.cpp
@@ -515,13 +515,17 @@ HRESULT CPanel::RefreshListCtrl(const CSelectedState &state)
   if (!_folder)
   {
     // throw 1;
     SetToRootFolder();
   }
   */
-  
+
+  UpdateNaviHistory();
+
+  _headerToolBar.EnableButton(kMoveBackwardID, IsBackwardAvailable());
+  _headerToolBar.EnableButton(kMoveForwardID, IsForwardAvailable());
   _headerToolBar.EnableButton(kParentFolderID, !IsRootFolder());
 
   {
     CMyComPtr<IFolderSetFlatMode> folderSetFlatMode;
     _folder.QueryInterface(IID_IFolderSetFlatMode, &folderSetFlatMode);
     if (folderSetFlatMode)
diff --git a/CPP/7zip/UI/FileManager/resource.h b/CPP/7zip/UI/FileManager/resource.h
index 9d605c6d..50735d89 100644
--- a/CPP/7zip/UI/FileManager/resource.h
+++ b/CPP/7zip/UI/FileManager/resource.h
@@ -17,12 +17,19 @@
 #define IDB_TEST2    152
 #define IDB_COPY2    153
 #define IDB_MOVE2    154
 #define IDB_DELETE2  155
 #define IDB_INFO2    156
 
+#define IDB_NAVIBAR  200
+
+#define NAVIBAR_BACK               0
+#define NAVIBAR_FORWARD            1
+#define NAVIBAR_UP                 2
+#define NAVIBAR_COUNT              3
+
 #define IDM_HASH_ALL             101
 #define IDM_CRC32                102
 #define IDM_CRC64                103
 #define IDM_SHA1                 104
 #define IDM_SHA256               105
 
diff --git a/CPP/7zip/UI/FileManager/resource.rc b/CPP/7zip/UI/FileManager/resource.rc
index 002265ae..06ff79d0 100644
--- a/CPP/7zip/UI/FileManager/resource.rc
+++ b/CPP/7zip/UI/FileManager/resource.rc
@@ -170,12 +170,13 @@ IDB_ADD2       BITMAP  "../../UI/FileManager/Add2.bmp"
 IDB_EXTRACT2   BITMAP  "../../UI/FileManager/Extract2.bmp"
 IDB_TEST2      BITMAP  "../../UI/FileManager/Test2.bmp"
 IDB_COPY2      BITMAP  "../../UI/FileManager/Copy2.bmp"
 IDB_MOVE2      BITMAP  "../../UI/FileManager/Move2.bmp"
 IDB_DELETE2    BITMAP  "../../UI/FileManager/Delete2.bmp"
 IDB_INFO2      BITMAP  "../../UI/FileManager/Info2.bmp"
+IDB_NAVIBAR    BITMAP  "../../UI/FileManager/Navibar.bmp"
 
 
 STRINGTABLE
 BEGIN
   IDS_BOOKMARK   "Bookmark"
 
-- 
2.41.0.windows.1

