From 84f5ede1dbb13eb87b66b8e7f5e430d9865a30de Mon Sep 17 00:00:00 2001
From: Florin9doi <Florin9doi@users.noreply.github.com>
Date: Sun, 2 Jul 2023 12:03:26 +0300
Subject: [PATCH] Support for Backward/forward navigation using MB4+5 and
 toolbar buttons

---
 CPP/7zip/UI/FileManager/App.cpp               |  15 ++++++
 CPP/7zip/UI/FileManager/AppState.h            |   9 +++-
 CPP/7zip/UI/FileManager/FM.cpp                |  16 ++++++-
 CPP/7zip/UI/FileManager/Navibar.bmp           | Bin 0 -> 934 bytes
 CPP/7zip/UI/FileManager/Panel.cpp             |  45 ++++++++++++++++--
 CPP/7zip/UI/FileManager/Panel.h               |  19 +++++++-
 CPP/7zip/UI/FileManager/PanelFolderChange.cpp |  33 +++++++++++++
 CPP/7zip/UI/FileManager/PanelItems.cpp        |   6 ++-
 CPP/7zip/UI/FileManager/resource.h            |   7 +++
 CPP/7zip/UI/FileManager/resource.rc           |   1 +
 10 files changed, 142 insertions(+), 9 deletions(-)
 create mode 100644 CPP/7zip/UI/FileManager/Navibar.bmp

diff --git a/CPP/7zip/UI/FileManager/App.cpp b/CPP/7zip/UI/FileManager/App.cpp
index 5b7d6167c..d285f0964 100644
--- a/CPP/7zip/UI/FileManager/App.cpp
+++ b/CPP/7zip/UI/FileManager/App.cpp
@@ -1002,3 +1002,18 @@ void CFolderHistory::AddString(const UString &s)
   AddUniqueStringToHead(Strings, s);
   Normalize();
 }
+
+void CFolderHistory::Push(const UString &s)
+{
+  NSynchronization::CCriticalSectionLock lock(_criticalSection);
+  Strings.Insert(0, s);
+  Normalize();
+}
+
+const UString CFolderHistory::Pop()
+{
+  NSynchronization::CCriticalSectionLock lock(_criticalSection);
+  UString ret = Strings.Front();
+  Strings.Delete(0);
+  return ret;
+}
diff --git a/CPP/7zip/UI/FileManager/AppState.h b/CPP/7zip/UI/FileManager/AppState.h
index 6630b9628..8b299f67d 100644
--- a/CPP/7zip/UI/FileManager/AppState.h
+++ b/CPP/7zip/UI/FileManager/AppState.h
@@ -52,7 +52,14 @@ class CFolderHistory
     NWindows::NSynchronization::CCriticalSectionLock lock(_criticalSection);
     foldersHistory = Strings;
   }
-  
+
+  int Size()
+  {
+    return Strings.Size();
+  }
+
+  void Push(const UString& s);
+  const UString Pop();
   void AddString(const UString &s);
 
   void RemoveAll()
diff --git a/CPP/7zip/UI/FileManager/FM.cpp b/CPP/7zip/UI/FileManager/FM.cpp
index b2f4c2b78..f1d7ae339 100644
--- a/CPP/7zip/UI/FileManager/FM.cpp
+++ b/CPP/7zip/UI/FileManager/FM.cpp
@@ -1066,7 +1066,21 @@ LRESULT CALLBACK WndProc(HWND hWnd, UINT message, WPARAM wParam, LPARAM lParam)
       ::ReleaseCapture();
       break;
     }
-    
+
+    case WM_APPCOMMAND:
+    {
+      switch (GET_APPCOMMAND_LPARAM(lParam))
+      {
+        case APPCOMMAND_BROWSER_BACKWARD:
+          g_App.Panels[g_App.LastFocusedPanel].MoveBackward();
+          return 0;
+        case APPCOMMAND_BROWSER_FORWARD:
+          g_App.Panels[g_App.LastFocusedPanel].MoveForward();
+          return 0;
+      }
+      break;
+    }
+
     case WM_MOUSEMOVE:
     {
       if ((wParam & MK_LBUTTON) != 0 && ::GetCapture() == hWnd)
diff --git a/CPP/7zip/UI/FileManager/Navibar.bmp b/CPP/7zip/UI/FileManager/Navibar.bmp
new file mode 100644
index 0000000000000000000000000000000000000000..f635c7135be1e871f02f9c5e30f913d5032511b4
GIT binary patch
literal 5238
zcmeH~O>V+K429DRu<C*%Z~_j{6^nA69<bsbaFf)*lJ(@5I36>p1OiPWXU6Zd-{eQ)
z>-_UM+<!+oALKa6v6tiHewILfmz^GZH4Ni0zQ=n9y6?dCdgIZ(%Krn!)cE_2W11<w
zL}g)Iu7>U9OE|R#VpFnOBX{woknMcQ<J1a&+?NqrORwH3O{norWv^IMdnj)bCQa#c
zSm+HKQ+d8Ur<KdhKu4K;u7ZT6*s1bQG7D{2gJ4p@$F>Uuffh5_m9|U_SQU7|B?s@t
z!QM1xvMZgDVCQk{;9NbH<ElfsKA9ZnFYN|a3}Of8>VX!Q9LJfGOD3;M9<k=&TpgQV
ziXFuIk$D_Wj!PQzZWs!+ES#M|+H3+(x++M(ScI4v#8W1GzBoqIYBI|+GfgEhdC6C@
zPeUd1GhQ&Km2dg8zM7g;RFecdkK+PdCG4xvp-2j<*paT*$Wt?~`2S1x1g&kf=b8Jm
SMUGl~F;n&!Z?R*~!u$grc=G`O

literal 0
HcmV?d00001

diff --git a/CPP/7zip/UI/FileManager/Panel.cpp b/CPP/7zip/UI/FileManager/Panel.cpp
index 84bd88c5a..c4ad44763 100644
--- a/CPP/7zip/UI/FileManager/Panel.cpp
+++ b/CPP/7zip/UI/FileManager/Panel.cpp
@@ -149,6 +149,17 @@ LRESULT CPanel::OnMessage(UINT message, WPARAM wParam, LPARAM lParam)
       if (OnContextMenu(HANDLE(wParam), GET_X_LPARAM(lParam), GET_Y_LPARAM(lParam)))
         return 0;
       break;
+    case WM_APPCOMMAND:
+      switch(GET_APPCOMMAND_LPARAM(lParam))
+      {
+        case APPCOMMAND_BROWSER_BACKWARD:
+          MoveBackward();
+          return 0;
+        case APPCOMMAND_BROWSER_FORWARD:
+          MoveForward();
+          return 0;
+      }
+      break;
     /*
     case WM_DROPFILES:
       CompressDropFiles(HDROP(wParam));
@@ -444,7 +455,9 @@ bool CPanel::OnCreate(CREATESTRUCT * /* createStruct */)
   const TBBUTTON tbb[] =
   {
     // {0, 0, TBSTATE_ENABLED, BTNS_SEP, 0L, 0},
-    {VIEW_PARENTFOLDER, kParentFolderID, TBSTATE_ENABLED, BTNS_BUTTON, { 0, 0 }, 0, 0 },
+    {NAVIBAR_BACK, kMoveBackwardID, TBSTATE_ENABLED, TBSTATE_INDETERMINATE, { 0, 0 }, 0, 0 },
+    {NAVIBAR_FORWARD, kMoveForwardID, TBSTATE_ENABLED, TBSTATE_INDETERMINATE, { 0, 0 }, 0, 0 },
+    {NAVIBAR_UP, kParentFolderID, TBSTATE_ENABLED, BTNS_BUTTON, { 0, 0 }, 0, 0 },
     // {0, 0, TBSTATE_ENABLED, BTNS_SEP, 0L, 0},
     // {VIEW_NEWFOLDER, kCreateFolderID, TBSTATE_ENABLED, BTNS_BUTTON, 0L, 0},
   };
@@ -485,12 +498,22 @@ bool CPanel::OnCreate(CREATESTRUCT * /* createStruct */)
       ;
   }
 
+  _headerImageList.Create(24, 24, ILC_MASK | ILC_COLOR32, 0, 0);
+  HBITMAP b = ::LoadBitmap(g_hInstance, MAKEINTRESOURCE(IDB_NAVIBAR));
+  if (b)
+  {
+    _headerImageList.AddMasked(b, RGB(255, 0, 255));
+    ::DeleteObject(b);
+  }
+
   _headerToolBar.Attach(::CreateToolbarEx ((*this), toolbarStyle,
-      _baseID + 2, 11,
-      (HINSTANCE)HINST_COMMCTRL,
-      IDB_VIEW_SMALL_COLOR,
+      _baseID + 2, NAVIBAR_COUNT,
+      NULL,
+      IDB_NAVIBAR,
       (LPCTBBUTTON)&tbb, Z7_ARRAY_SIZE(tbb),
-      0, 0, 0, 0, sizeof (TBBUTTON)));
+      24, 24, 24, 24, sizeof (TBBUTTON)));
+
+  _headerToolBar.SetImageList(0, _headerImageList);
 
   #ifndef UNDER_CE
   // Load ComboBoxEx class
@@ -726,6 +749,18 @@ bool CPanel::OnNotify(UINT /* controlID */, LPNMHDR header, LRESULT &result)
 
 bool CPanel::OnCommand(unsigned code, unsigned itemID, LPARAM lParam, LRESULT &result)
 {
+  if (itemID == kMoveBackwardID)
+  {
+    MoveBackward();
+    result = 0;
+    return true;
+  }
+  if (itemID == kMoveForwardID)
+  {
+    MoveForward();
+    result = 0;
+    return true;
+  }
   if (itemID == kParentFolderID)
   {
     OpenParentFolder();
diff --git a/CPP/7zip/UI/FileManager/Panel.h b/CPP/7zip/UI/FileManager/Panel.h
index 9ef09265e..111723729 100644
--- a/CPP/7zip/UI/FileManager/Panel.h
+++ b/CPP/7zip/UI/FileManager/Panel.h
@@ -26,6 +26,7 @@
 
 #include "../../../Windows/Control/ComboBox.h"
 #include "../../../Windows/Control/Edit.h"
+#include "../../../Windows/Control/ImageList.h"
 #include "../../../Windows/Control/ListView.h"
 #include "../../../Windows/Control/ReBar.h"
 #include "../../../Windows/Control/Static.h"
@@ -49,7 +50,12 @@
 #define NON_CE_VAR(_v_) _v_
 #endif
 
-const int kParentFolderID = 100;
+enum
+{
+  kMoveBackwardID = 100,
+  kMoveForwardID,
+  kParentFolderID
+};
 
 const unsigned kParentIndex = (unsigned)(int)-1;
 const UInt32 kParentIndex_UInt32 = (UInt32)(Int32)kParentIndex;
@@ -430,6 +436,7 @@ class CPanel Z7_final: public NWindows::NControl::CWindow2
 
   NWindows::NControl::CReBar _headerReBar;
   NWindows::NControl::CToolBar _headerToolBar;
+  NWindows::NControl::CImageList _headerImageList;
   NWindows::NControl::
     #ifdef UNDER_CE
     CComboBox
@@ -446,6 +453,7 @@ class CPanel Z7_final: public NWindows::NControl::CWindow2
   CBoolVector _selectedStatusVector;
   CSelectedState _selectedState;
 
+  UString _lastFolderPrefix;
   UString _currentFolderPrefix;
   
   CObjectVector<CFolderLink> _parentFolders;
@@ -459,6 +467,15 @@ class CPanel Z7_final: public NWindows::NControl::CWindow2
   CMyComPtr<IFolderAltStreams> _folderAltStreams;
   CMyComPtr<IFolderOperations> _folderOperations;
 
+  CFolderHistory _backwardHistory;
+  CFolderHistory _forwardHistory;
+  bool _IsNaviTriggered;
+  bool IsBackwardAvailable() { return _backwardHistory.Size() > 0; }
+  bool IsForwardAvailable() { return _forwardHistory.Size() > 0; }
+  void MoveBackward();
+  void MoveForward();
+  void UpdateNaviHistory();
+
   // for drag and drop highliting
   int m_DropHighlighted_SelectionIndex;
   // int m_SubFolderIndex;      // realIndex of item in m_Panel list (if drop cursor to that item)
diff --git a/CPP/7zip/UI/FileManager/PanelFolderChange.cpp b/CPP/7zip/UI/FileManager/PanelFolderChange.cpp
index b0fb53e1d..c99d9fb43 100644
--- a/CPP/7zip/UI/FileManager/PanelFolderChange.cpp
+++ b/CPP/7zip/UI/FileManager/PanelFolderChange.cpp
@@ -1040,6 +1040,39 @@ void CPanel::OpenRootFolder()
   */
 }
 
+void CPanel::MoveBackward()
+{
+  if (_backwardHistory.Size() > 0)
+  {
+    _IsNaviTriggered = true;
+    _forwardHistory.Push(_currentFolderPrefix);
+    UString path = _backwardHistory.Pop();
+    BindToPathAndRefresh(path);
+  }
+}
+
+void CPanel::MoveForward()
+{
+  if (_forwardHistory.Size() > 0)
+  {
+    _IsNaviTriggered = true;
+    _backwardHistory.Push(_currentFolderPrefix);
+    UString path = _forwardHistory.Pop();
+    BindToPathAndRefresh(path);
+  }
+}
+
+void CPanel::UpdateNaviHistory()
+{
+  if (_lastFolderPrefix != _currentFolderPrefix && PanelCreated && !_IsNaviTriggered)
+  {
+    _backwardHistory.Push(_lastFolderPrefix);
+    _forwardHistory.RemoveAll();
+  }
+  _lastFolderPrefix = _currentFolderPrefix;
+  _IsNaviTriggered = false;
+}
+
 void CPanel::OpenDrivesFolder()
 {
   CloseOpenFolders();
diff --git a/CPP/7zip/UI/FileManager/PanelItems.cpp b/CPP/7zip/UI/FileManager/PanelItems.cpp
index 868ad227d..0f59cb74d 100644
--- a/CPP/7zip/UI/FileManager/PanelItems.cpp
+++ b/CPP/7zip/UI/FileManager/PanelItems.cpp
@@ -519,7 +519,11 @@ HRESULT CPanel::RefreshListCtrl(const CSelectedState &state)
     SetToRootFolder();
   }
   */
-  
+
+  UpdateNaviHistory();
+
+  _headerToolBar.EnableButton(kMoveBackwardID, IsBackwardAvailable());
+  _headerToolBar.EnableButton(kMoveForwardID, IsForwardAvailable());
   _headerToolBar.EnableButton(kParentFolderID, !IsRootFolder());
 
   {
diff --git a/CPP/7zip/UI/FileManager/resource.h b/CPP/7zip/UI/FileManager/resource.h
index 36c4b531a..02522385e 100644
--- a/CPP/7zip/UI/FileManager/resource.h
+++ b/CPP/7zip/UI/FileManager/resource.h
@@ -20,6 +20,13 @@
 #define IDB_DELETE2  155
 #define IDB_INFO2    156
 
+#define IDB_NAVIBAR  200
+
+#define NAVIBAR_BACK               0
+#define NAVIBAR_FORWARD            1
+#define NAVIBAR_UP                 2
+#define NAVIBAR_COUNT              3
+
 #define IDM_HASH_ALL             101
 #define IDM_CRC32                102
 #define IDM_CRC64                103
diff --git a/CPP/7zip/UI/FileManager/resource.rc b/CPP/7zip/UI/FileManager/resource.rc
index d9fc6f25e..b6c84a47d 100644
--- a/CPP/7zip/UI/FileManager/resource.rc
+++ b/CPP/7zip/UI/FileManager/resource.rc
@@ -181,6 +181,7 @@ IDB_COPY2      BITMAP  "../../UI/FileManager/Copy2.bmp"
 IDB_MOVE2      BITMAP  "../../UI/FileManager/Move2.bmp"
 IDB_DELETE2    BITMAP  "../../UI/FileManager/Delete2.bmp"
 IDB_INFO2      BITMAP  "../../UI/FileManager/Info2.bmp"
+IDB_NAVIBAR    BITMAP  "../../UI/FileManager/Navibar.bmp"
 
 
 STRINGTABLE
