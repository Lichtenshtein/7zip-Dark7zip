From bae63db2d073b40286bc0afb4bb444f014284a8a Mon Sep 17 00:00:00 2001
From: ozone10 <positronix10@gmail.com>
Date: Wed, 11 Jun 2025 19:45:20 +0200
Subject: [PATCH] Tab focus rect, tweaks

---
 DarkMode/7zDark.ini           |   8 +-
 DarkMode/DarkMode.cpp         |   2 +-
 DarkMode/DarkModeSubclass.cpp | 202 +++++++++++++++++++++++++++++-----
 DarkMode/DarkModeSubclass.h   |   2 +-
 DarkMode/IatHook.h            |   8 +-
 README.md                     |  10 +-
 6 files changed, 189 insertions(+), 43 deletions(-)

diff --git a/DarkMode/7zDark.ini b/DarkMode/7zDark.ini
index bfe044e2d..5e4b98c0d 100644
--- a/DarkMode/7zDark.ini
+++ b/DarkMode/7zDark.ini
@@ -9,8 +9,8 @@ mica = 0
 
 [dark.colors]
 background =            "202020"
-backgroundCtrl =        "404040"
-backgroundHot =         "404040"
+backgroundCtrl =        "383838"
+backgroundHot =         "454545"
 backgroundDlg =         "202020"
 text =                  "E0E0E0"
 textItem =              "C0C0C0"
@@ -20,8 +20,8 @@ edgeHot =               "9B9B9B"
 edgeDisabled =          "484848"
 
 [dark.colors.view]
-backgroundView =        "112435"
-textView =              "C3BE98"
+backgroundView =        "3F3F3F"
+textView =              "DCDCDC"
 gridlines =             "646464"
 backgroundHeader =      "202020"
 backgroundHotHeader =   "404040"
diff --git a/DarkMode/DarkMode.cpp b/DarkMode/DarkMode.cpp
index 9f71b6b1d..2cbd55672 100644
--- a/DarkMode/DarkMode.cpp
+++ b/DarkMode/DarkMode.cpp
@@ -270,7 +270,7 @@ bool IsColorSchemeChangeMessage(LPARAM lParam)
 {
 	bool isMsg = false;
 	if ((lParam != 0) // NULL
-		&& (lstrcmpiW(reinterpret_cast<LPCWSTR>(lParam), L"ImmersiveColorSet") == 0)
+		&& (_wcsicmp(reinterpret_cast<LPCWSTR>(lParam), L"ImmersiveColorSet") == 0)
 		&& _RefreshImmersiveColorPolicyState != nullptr)
 	{
 		_RefreshImmersiveColorPolicyState();
diff --git a/DarkMode/DarkModeSubclass.cpp b/DarkMode/DarkModeSubclass.cpp
index b31a98565..eb98d62e5 100644
--- a/DarkMode/DarkModeSubclass.cpp
+++ b/DarkMode/DarkModeSubclass.cpp
@@ -53,7 +53,7 @@
 
 #if defined(__GNUC__)
 #include <cstdint>
-static constexpr DWORD DWMWA_USE_IMMERSIVE_DARK_MODE 20
+//static constexpr DWORD DWMWA_USE_IMMERSIVE_DARK_MODE = 20;
 static constexpr int CP_DROPDOWNITEM = 9; // for some reason mingw use only enum up to 8
 #endif
 
@@ -311,7 +311,7 @@ namespace DarkMode
 
 		Brushes() = delete;
 
-		explicit Brushes(const Colors& colors)
+		explicit Brushes(const Colors& colors) noexcept
 			: _background(::CreateSolidBrush(colors.background))
 			, _ctrlBackground(::CreateSolidBrush(colors.ctrlBackground))
 			, _hotBackground(::CreateSolidBrush(colors.hotBackground))
@@ -375,7 +375,7 @@ namespace DarkMode
 
 		Pens() = delete;
 
-		explicit Pens(const Colors& colors)
+		explicit Pens(const Colors& colors) noexcept
 			: _darkerText(::CreatePen(PS_SOLID, 1, colors.darkerText))
 			, _edge(::CreatePen(PS_SOLID, 1, colors.edge))
 			, _hotEdge(::CreatePen(PS_SOLID, 1, colors.hotEdge))
@@ -554,13 +554,13 @@ namespace DarkMode
 	class Theme
 	{
 	public:
-		Theme()
+		Theme() noexcept
 			: _colors(darkColors)
 			, _brushes(darkColors)
 			, _pens(darkColors)
 		{}
 
-		explicit Theme(const Colors& colors)
+		explicit Theme(const Colors& colors) noexcept
 			: _colors(colors)
 			, _brushes(colors)
 			, _pens(colors)
@@ -697,7 +697,7 @@ namespace DarkMode
 
 		BrushesAndPensView() = delete;
 
-		explicit BrushesAndPensView(const ColorsView& colors)
+		explicit BrushesAndPensView(const ColorsView& colors) noexcept
 			: _background(::CreateSolidBrush(colors.background))
 			, _gridlines(::CreateSolidBrush(colors.gridlines))
 			, _headerBackground(::CreateSolidBrush(colors.headerBackground))
@@ -743,12 +743,12 @@ namespace DarkMode
 	class ThemeView
 	{
 	public:
-		ThemeView()
+		ThemeView() noexcept
 			: _clrView(darkColorsView)
 			, _hbrPnView(darkColorsView)
 		{}
 
-		explicit ThemeView(const ColorsView& colorsView)
+		explicit ThemeView(const ColorsView& colorsView) noexcept
 			: _clrView(colorsView)
 			, _hbrPnView(colorsView)
 		{}
@@ -782,7 +782,7 @@ namespace DarkMode
 		return tView;
 	}
 
-	inline static COLORREF setNewColor(COLORREF* clrOld, COLORREF clrNew)
+	static COLORREF setNewColor(COLORREF* clrOld, COLORREF clrNew)
 	{
 		const auto clrTmp = *clrOld;
 		*clrOld = clrNew;
@@ -1293,7 +1293,7 @@ namespace DarkMode
 			return _hTheme != nullptr;
 		}
 
-		void closeTheme()
+		void closeTheme() noexcept
 		{
 			if (_hTheme != nullptr)
 			{
@@ -1345,7 +1345,7 @@ namespace DarkMode
 			return _hMemDC != nullptr && _hMemBmp != nullptr;
 		}
 
-		void releaseBuffer()
+		void releaseBuffer() noexcept
 		{
 			if (_hMemDC != nullptr)
 			{
@@ -1377,7 +1377,7 @@ namespace DarkMode
 	public:
 		FontData() = default;
 
-		explicit FontData(HFONT hFont)
+		explicit FontData(HFONT hFont) noexcept
 			: _hFont(hFont)
 		{}
 
@@ -1392,23 +1392,23 @@ namespace DarkMode
 			FontData::destroyFont();
 		}
 
-		void setFont(HFONT newFont)
+		void setFont(HFONT newFont) noexcept
 		{
 			FontData::destroyFont();
 			_hFont = newFont;
 		}
 
-		[[nodiscard]] const HFONT& getFont() const
+		[[nodiscard]] const HFONT& getFont() const noexcept
 		{
 			return _hFont;
 		}
 
-		[[nodiscard]] bool hasFont() const
+		[[nodiscard]] bool hasFont() const noexcept
 		{
 			return _hFont != nullptr;
 		}
 
-		void destroyFont()
+		void destroyFont() noexcept
 		{
 			if (FontData::hasFont())
 			{
@@ -1830,6 +1830,11 @@ namespace DarkMode
 				}
 				break;
 			}
+
+			default:
+			{
+				break;
+			}
 		}
 		return ::DefSubclassProc(hWnd, uMsg, wParam, lParam);
 	}
@@ -2019,6 +2024,11 @@ namespace DarkMode
 				::RedrawWindow(hWnd, nullptr, nullptr, RDW_INVALIDATE);
 				break;
 			}
+
+			default:
+			{
+				break;
+			}
 		}
 		return ::DefSubclassProc(hWnd, uMsg, wParam, lParam);
 	}
@@ -2259,7 +2269,7 @@ namespace DarkMode
 					break;
 				}
 
-				auto hdc = reinterpret_cast<HDC>(wParam);
+				const auto* hdc = reinterpret_cast<HDC>(wParam);
 				if (hdc != hMemDC)
 				{
 					return FALSE;
@@ -2358,6 +2368,11 @@ namespace DarkMode
 
 				break;
 			}
+
+			default:
+			{
+				break;
+			}
 		}
 		return ::DefSubclassProc(hWnd, uMsg, wParam, lParam);
 	}
@@ -2405,9 +2420,15 @@ namespace DarkMode
 		::GetCursorPos(&ptCursor);
 		::ScreenToClient(hWnd, &ptCursor);
 
-		const int nTabs = TabCtrl_GetItemCount(hWnd);
+		bool hasFocusRect = false;
+		if (::GetFocus() == hWnd)
+		{
+			const auto uiState = static_cast<DWORD>(::SendMessage(hWnd, WM_QUERYUISTATE, 0, 0));
+			hasFocusRect = ((uiState & UISF_HIDEFOCUS) != UISF_HIDEFOCUS);
+		}
 
 		const int iSelTab = TabCtrl_GetCurSel(hWnd);
+		const int nTabs = TabCtrl_GetItemCount(hWnd);
 		for (int i = 0; i < nTabs; ++i)
 		{
 			RECT rcItem{};
@@ -2495,8 +2516,15 @@ namespace DarkMode
 				}
 
 				::DrawText(hdc, label.c_str(), -1, &rcText, DT_CENTER | DT_VCENTER | DT_SINGLELINE);
+
 				::FrameRect(hdc, &rcFrame, DarkMode::getEdgeBrush());
 
+				if (isSelectedTab && hasFocusRect)
+				{
+					::InflateRect(&rcFrame, -2, -1);
+					::DrawFocusRect(hdc, &rcFrame);
+				}
+
 				::SelectClipRgn(hdc, holdClip);
 				::DeleteObject(hClip);
 			}
@@ -2542,7 +2570,7 @@ namespace DarkMode
 					break;
 				}
 
-				auto hdc = reinterpret_cast<HDC>(wParam);
+				const auto* hdc = reinterpret_cast<HDC>(wParam);
 				if (hdc != hMemDC)
 				{
 					return FALSE;
@@ -2601,6 +2629,20 @@ namespace DarkMode
 				::EndPaint(hWnd, &ps);
 				return 0;
 			}
+
+			case WM_UPDATEUISTATE:
+			{
+				if ((HIWORD(wParam) & (UISF_HIDEACCEL | UISF_HIDEFOCUS)) != 0)
+				{
+					::InvalidateRect(hWnd, nullptr, FALSE);
+				}
+				break;
+			}
+
+			default:
+			{
+				break;
+			}
 		}
 		return ::DefSubclassProc(hWnd, uMsg, wParam, lParam);
 	}
@@ -2648,9 +2690,19 @@ namespace DarkMode
 						}
 						break;
 					}
+
+					default:
+					{
+						break;
+					}
 				}
 				return 0;
 			}
+
+			default:
+			{
+				break;
+			}
 		}
 		return ::DefSubclassProc(hWnd, uMsg, wParam, lParam);
 	}
@@ -2861,6 +2913,11 @@ namespace DarkMode
 				::TrackMouseEvent(&tme);
 				break;
 			}
+
+			default:
+			{
+				break;
+			}
 		}
 		return ::DefSubclassProc(hWnd, uMsg, wParam, lParam);
 	}
@@ -2908,7 +2965,7 @@ namespace DarkMode
 
 		LONG_PTR _cbStyle = CBS_SIMPLE;
 
-		ComboboxData() = default;
+		ComboboxData() = delete;
 
 		explicit ComboboxData(LONG_PTR cbStyle)
 			: _cbStyle(cbStyle)
@@ -3124,7 +3181,7 @@ namespace DarkMode
 					break;
 				}
 
-				auto hdc = reinterpret_cast<HDC>(wParam);
+				const auto* hdc = reinterpret_cast<HDC>(wParam);
 				if (pComboboxData->_cbStyle != CBS_DROPDOWN && hdc != hMemDC)
 				{
 					return FALSE;
@@ -3209,6 +3266,11 @@ namespace DarkMode
 				themeData.closeTheme();
 				break;
 			}
+
+			default:
+			{
+				break;
+			}
 		}
 		return ::DefSubclassProc(hWnd, uMsg, wParam, lParam);
 	}
@@ -3344,6 +3406,11 @@ namespace DarkMode
 				}
 				break;
 			}
+
+			default:
+			{
+				break;
+			}
 		}
 		return ::DefSubclassProc(hWnd, uMsg, wParam, lParam);
 	}
@@ -3454,12 +3521,24 @@ namespace DarkMode
 							}
 
 							default:
+							{
 								return CDRF_DODEFAULT;
+							}
 						}
 					}
+
+					default:
+					{
+						break;
+					}
 				}
 				break;
 			}
+
+			default:
+			{
+				break;
+			}
 		}
 		return ::DefSubclassProc(hWnd, uMsg, wParam, lParam);
 	}
@@ -3509,7 +3588,7 @@ namespace DarkMode
 		bool _hasBtnStyle = true;
 		bool _isPressed = false;
 
-		HeaderData() = default;
+		HeaderData() = delete;
 
 		explicit HeaderData(bool hasBtnStyle)
 			: _hasBtnStyle(hasBtnStyle)
@@ -3689,7 +3768,7 @@ namespace DarkMode
 					break;
 				}
 
-				auto hdc = reinterpret_cast<HDC>(wParam);
+				const auto* hdc = reinterpret_cast<HDC>(wParam);
 				if (hdc != hMemDC)
 				{
 					return FALSE;
@@ -3822,6 +3901,11 @@ namespace DarkMode
 
 				return retVal;
 			}
+
+			default:
+			{
+				break;
+			}
 		}
 		return ::DefSubclassProc(hWnd, uMsg, wParam, lParam);
 	}
@@ -3988,7 +4072,7 @@ namespace DarkMode
 					break;
 				}
 
-				auto hdc = reinterpret_cast<HDC>(wParam);
+				const auto* hdc = reinterpret_cast<HDC>(wParam);
 				if (hdc != hMemDC)
 				{
 					return FALSE;
@@ -4063,6 +4147,11 @@ namespace DarkMode
 				}
 				break;
 			}
+
+			default:
+			{
+				break;
+			}
 		}
 		return ::DefSubclassProc(hWnd, uMsg, wParam, lParam);
 	}
@@ -4098,8 +4187,6 @@ namespace DarkMode
 		BufferData _bufferData;
 
 		int _iStateID = PBFS_PARTIAL; // PBFS_PARTIAL for cyan color
-
-		ProgressBarData() = default;
 	};
 
 	static void getProgressBarRects(HWND hWnd, RECT* rcEmpty, RECT* rcFilled)
@@ -4173,7 +4260,7 @@ namespace DarkMode
 					break;
 				}
 
-				auto hdc = reinterpret_cast<HDC>(wParam);
+				const auto* hdc = reinterpret_cast<HDC>(wParam);
 				if (hdc != hMemDC)
 				{
 					return FALSE;
@@ -4261,9 +4348,19 @@ namespace DarkMode
 						pProgressBarData->_iStateID = PBFS_PAUSED; // yellow
 						break;
 					}
+
+					default:
+					{
+						break;
+					}
 				}
 				break;
 			}
+
+			default:
+			{
+				break;
+			}
 		}
 		return ::DefSubclassProc(hWnd, uMsg, wParam, lParam);
 	}
@@ -4348,6 +4445,11 @@ namespace DarkMode
 
 				return 0;
 			}
+
+			default:
+			{
+				break;
+			}
 		}
 		return ::DefSubclassProc(hWnd, uMsg, wParam, lParam);
 	}
@@ -4578,6 +4680,11 @@ namespace DarkMode
 				::FillRect(reinterpret_cast<HDC>(wParam), &rcClient, DarkMode::getDlgBackgroundBrush());
 				return TRUE;
 			}
+
+			default:
+			{
+				break;
+			}
 		}
 		return ::DefSubclassProc(hWnd, uMsg, wParam, lParam);
 	}
@@ -4683,6 +4790,11 @@ namespace DarkMode
 				}
 				return TRUE;
 			}
+
+			default:
+			{
+				break;
+			}
 		}
 		return ::DefSubclassProc(hWnd, uMsg, wParam, lParam);
 	}
@@ -4839,7 +4951,9 @@ namespace DarkMode
 			}
 
 			default:
+			{
 				break;
+			}
 		}
 		return ::DefSubclassProc(hWnd, uMsg, wParam, lParam);
 	}
@@ -4879,7 +4993,7 @@ namespace DarkMode
 				const LONG paddingLeft = DarkMode::isThemeDark() ? 1 : 0;
 				const LONG paddingRight = DarkMode::isThemeDark() ? 2 : 1;
 
-				const LVITEMINDEX lvii{ static_cast<int>(lplvcd->nmcd.dwItemSpec), 0 };
+				LVITEMINDEX lvii{ static_cast<int>(lplvcd->nmcd.dwItemSpec), 0 };
 				RECT rcSubitem{
 					lplvcd->nmcd.rc.left
 					, lplvcd->nmcd.rc.top
@@ -4949,7 +5063,9 @@ namespace DarkMode
 			}
 
 			default:
+			{
 				break;
+			}
 		}
 		return ::DefSubclassProc(hWnd, uMsg, wParam, lParam);
 	}
@@ -5020,7 +5136,9 @@ namespace DarkMode
 			}
 
 			default:
+			{
 				break;
+			}
 		}
 		return ::DefSubclassProc(hWnd, uMsg, wParam, lParam);
 	}
@@ -5066,13 +5184,17 @@ namespace DarkMode
 					}
 
 					default:
+					{
 						break;
+					}
 				}
 				break;
 			}
 
 			default:
+			{
 				break;
+			}
 		}
 		return ::DefSubclassProc(hWnd, uMsg, wParam, lParam);
 	}
@@ -5132,7 +5254,9 @@ namespace DarkMode
 			}
 
 			default:
+			{
 				break;
+			}
 		}
 		return ::DefSubclassProc(hWnd, uMsg, wParam, lParam);
 	}
@@ -5198,10 +5322,17 @@ namespace DarkMode
 					}
 
 					default:
+					{
 						break;
+					}
 				}
 				break;
 			}
+
+			default:
+			{
+				break;
+			}
 		}
 		return ::DefSubclassProc(hWnd, uMsg, wParam, lParam);
 	}
@@ -5409,6 +5540,11 @@ namespace DarkMode
 						dttopts.crText = DarkMode::getDisabledTextColor();
 						break;
 					}
+
+					default:
+					{
+						break;
+					}
 				}
 
 				::DrawThemeTextEx(hTheme, pUDMI->um.hdc, MENU_BARITEM, iTextStateID, buffer.c_str(), static_cast<int>(mii.cch), dwFlags, &pUDMI->dis.rcItem, &dttopts);
@@ -5437,6 +5573,11 @@ namespace DarkMode
 				DarkMode::drawUAHMenuNCBottomLine(hWnd);
 				return retVal;
 			}
+
+			default:
+			{
+				break;
+			}
 		}
 		return ::DefSubclassProc(hWnd, uMsg, wParam, lParam);
 	}
@@ -5480,6 +5621,11 @@ namespace DarkMode
 				}
 				break;
 			}
+
+			default:
+			{
+				break;
+			}
 		}
 		return ::DefSubclassProc(hWnd, uMsg, wParam, lParam);
 	}
diff --git a/DarkMode/DarkModeSubclass.h b/DarkMode/DarkModeSubclass.h
index 61c9ebaea..b2119897c 100644
--- a/DarkMode/DarkModeSubclass.h
+++ b/DarkMode/DarkModeSubclass.h
@@ -230,7 +230,7 @@ namespace DarkMode
 	// paint helper
 
 	void paintRoundRect(HDC hdc, const RECT& rect, HPEN hpen, HBRUSH hBrush, int width = 0, int height = 0);
-	inline void paintRoundFrameRect(HDC hdc, const RECT& rect, HPEN hpen, int width = 0, int height = 0);
+	void paintRoundFrameRect(HDC hdc, const RECT& rect, HPEN hpen, int width = 0, int height = 0);
 
 	// control subclassing
 
diff --git a/DarkMode/IatHook.h b/DarkMode/IatHook.h
index 36d6f0722..b81516db9 100644
--- a/DarkMode/IatHook.h
+++ b/DarkMode/IatHook.h
@@ -21,9 +21,9 @@ inline constexpr T RVA2VA(T1 base, T2 rva)
 template <typename T>
 inline constexpr T DataDirectoryFromModuleBase(void* moduleBase, size_t entryID)
 {
-	auto* dosHdr = static_cast<PIMAGE_DOS_HEADER>(moduleBase);
-	auto* ntHdr = RVA2VA<PIMAGE_NT_HEADERS>(moduleBase, static_cast<DWORD>(dosHdr->e_lfanew));
-	auto* dataDir = ntHdr->OptionalHeader.DataDirectory;
+	const auto* dosHdr = static_cast<PIMAGE_DOS_HEADER>(moduleBase);
+	const auto* ntHdr = RVA2VA<PIMAGE_NT_HEADERS>(moduleBase, static_cast<DWORD>(dosHdr->e_lfanew));
+	const auto* dataDir = ntHdr->OptionalHeader.DataDirectory;
 	return RVA2VA<T>(moduleBase, dataDir[entryID].VirtualAddress);
 }
 
@@ -36,7 +36,7 @@ inline PIMAGE_THUNK_DATA FindAddressByName(void* moduleBase, PIMAGE_THUNK_DATA i
 			continue;
 		}
 
-		auto* import = RVA2VA<PIMAGE_IMPORT_BY_NAME>(moduleBase, impName->u1.AddressOfData);
+		const auto* import = RVA2VA<PIMAGE_IMPORT_BY_NAME>(moduleBase, impName->u1.AddressOfData);
 		if (strcmp(reinterpret_cast<const char*>(import->Name), funcName) != 0)
 		{
 			continue;
