From 6b453cdc6fe24f2ae3f2026a0ff5e7fec1e927c2 Mon Sep 17 00:00:00 2001
From: ozone10 <positronix10@gmail.com>
Date: Tue, 29 Apr 2025 09:23:35 +0200
Subject: [PATCH] Tweaks

---
 DarkMode/DarkMode.cpp         |  4 ++++
 DarkMode/DarkModeSubclass.cpp | 22 +++++++++++++++++-----
 DarkMode/DarkModeSubclass.h   |  1 +
 DarkMode/IatHook.h            |  3 +--
 DarkMode/UAHMenuBar.h         |  2 +-
 5 files changed, 24 insertions(+), 8 deletions(-)

diff --git a/DarkMode/DarkMode.cpp b/DarkMode/DarkMode.cpp
index 5addb12ca..b08a2eebb 100644
--- a/DarkMode/DarkMode.cpp
+++ b/DarkMode/DarkMode.cpp
@@ -1,5 +1,9 @@
 #include "StdAfx.h"
 
+#ifndef WIN32_LEAN_AND_MEAN
+#define WIN32_LEAN_AND_MEAN
+#endif
+
 #include <windows.h>
 
 #include "DarkMode.h"
diff --git a/DarkMode/DarkModeSubclass.cpp b/DarkMode/DarkModeSubclass.cpp
index 208174170..5c8d6e467 100644
--- a/DarkMode/DarkModeSubclass.cpp
+++ b/DarkMode/DarkModeSubclass.cpp
@@ -20,6 +20,13 @@
 
 #include "StdAfx.h"
 
+#ifndef WIN32_LEAN_AND_MEAN
+#define WIN32_LEAN_AND_MEAN
+#endif
+#ifndef NOMINMAX
+#define NOMINMAX
+#endif
+
 #include "DarkModeSubclass.h"
 
 #include "DarkMode.h"
@@ -41,6 +48,7 @@
 #ifndef DWMWA_USE_IMMERSIVE_DARK_MODE
 #define DWMWA_USE_IMMERSIVE_DARK_MODE 20
 #endif
+constexpr int CP_DROPDOWNITEM = 9; // for some reason mingw use only enum up to 8
 #else
 #define WINAPI_LAMBDA
 #endif
@@ -138,7 +146,7 @@ static bool setClrFromIni(std::wstring sectionName, std::wstring keyName, std::w
 		}
 	}
 
-	COLORREF clrTmp{ *clr };
+	COLORREF clrTmp = 0;
 
 	try
 	{
@@ -423,6 +431,8 @@ namespace DarkMode
 
 	void setDarkCustomColors(ColorTone colorTone)
 	{
+		g_colorToneChoice = colorTone;
+
 		switch (colorTone)
 		{
 			case DarkMode::ColorTone::red:
@@ -470,6 +480,11 @@ namespace DarkMode
 		}
 	}
 
+	ColorTone getColorTone()
+	{
+		return g_colorToneChoice;
+	}
+
 	struct Theme
 	{
 		Colors _colors;
@@ -2402,9 +2417,6 @@ namespace DarkMode
 					dtto.dwFlags = DTT_TEXTCOLOR;
 					dtto.crText = isDisabled ? DarkMode::getDisabledTextColor() : DarkMode::getTextColor();
 
-#ifdef __GNUC__
-					constexpr int CP_DROPDOWNITEM = 9; // for some reason mingw use only enum up to 8
-#endif
 					::DrawThemeTextEx(hTheme, hdc, CP_DROPDOWNITEM, isDisabled ? CBXSR_DISABLED : CBXSR_NORMAL, buffer, -1, dtFlags, &rcText, &dtto);
 				}
 				else
@@ -4853,7 +4865,7 @@ namespace DarkMode
 			{
 				if (g_micaExtend && g_mica != DWMSBT_AUTO && !g_enableWindowsMode && g_useDarkMode)
 				{
-					constexpr MARGINS margins = { -1 };
+					constexpr MARGINS margins{ -1, 0, 0, 0 };
 					::DwmExtendFrameIntoClientArea(hWnd, &margins);
 				}
 
diff --git a/DarkMode/DarkModeSubclass.h b/DarkMode/DarkModeSubclass.h
index 1ea75d02d..2c7abcf50 100644
--- a/DarkMode/DarkModeSubclass.h
+++ b/DarkMode/DarkModeSubclass.h
@@ -104,6 +104,7 @@ namespace DarkMode
 	void enableDarkScrollBarForWindowAndChildren(HWND hWnd);
 
 	void setDarkCustomColors(ColorTone colorTone);
+	ColorTone getColorTone();
 
 	COLORREF setBackgroundColor(COLORREF clrNew);
 	COLORREF setCtrlBackgroundColor(COLORREF clrNew);
diff --git a/DarkMode/IatHook.h b/DarkMode/IatHook.h
index 6f1a5d358..fe39c6b9a 100644
--- a/DarkMode/IatHook.h
+++ b/DarkMode/IatHook.h
@@ -37,9 +37,8 @@ PIMAGE_THUNK_DATA FindAddressByName(void *moduleBase, PIMAGE_THUNK_DATA impName,
 	return nullptr;
 }
 
-PIMAGE_THUNK_DATA FindAddressByOrdinal(void *moduleBase, PIMAGE_THUNK_DATA impName, PIMAGE_THUNK_DATA impAddr, uint16_t ordinal)
+PIMAGE_THUNK_DATA FindAddressByOrdinal(void */*moduleBase*/, PIMAGE_THUNK_DATA impName, PIMAGE_THUNK_DATA impAddr, uint16_t ordinal)
 {
-	UNREFERENCED_PARAMETER(moduleBase);
 	for (; impName->u1.Ordinal; ++impName, ++impAddr)
 	{
 		if (IMAGE_SNAP_BY_ORDINAL(impName->u1.Ordinal) && IMAGE_ORDINAL(impName->u1.Ordinal) == ordinal)
diff --git a/DarkMode/UAHMenuBar.h b/DarkMode/UAHMenuBar.h
index 830060b99..f43181ba2 100644
--- a/DarkMode/UAHMenuBar.h
+++ b/DarkMode/UAHMenuBar.h
@@ -6,7 +6,7 @@
 
 // processes messages related to UAH / custom menubar drawing.
 // return true if handled, false to continue with normal processing in your wndproc
-bool UAHDarkModeWndProc(HWND hWnd, UINT message, WPARAM wParam, LPARAM lParam, LRESULT* lr);
+//bool UAHDarkModeWndProc(HWND hWnd, UINT message, WPARAM wParam, LPARAM lParam, LRESULT* lr);
 
 // window messages related to menu bar drawing
 #define WM_UAHDESTROYWINDOW    0x0090	// handled by DefWindowProc
