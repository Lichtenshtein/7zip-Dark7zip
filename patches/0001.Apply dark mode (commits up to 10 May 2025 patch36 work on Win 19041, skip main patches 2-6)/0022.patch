From 3830e1717ce629cb5e7de320791533188e0e04df Mon Sep 17 00:00:00 2001
From: ozone10 <positronix10@gmail.com>
Date: Tue, 22 Apr 2025 15:33:43 +0200
Subject: [PATCH] Tweaks

---
 DarkMode/DarkMode.cpp         | 10 +++++-----
 DarkMode/DarkModeSubclass.cpp | 30 +++++++++++++++++++++++++-----
 2 files changed, 30 insertions(+), 10 deletions(-)

diff --git a/DarkMode/DarkMode.cpp b/DarkMode/DarkMode.cpp
index 68fdc5c52..5addb12ca 100644
--- a/DarkMode/DarkMode.cpp
+++ b/DarkMode/DarkMode.cpp
@@ -209,7 +209,7 @@ void AllowDarkModeForApp(bool allow)
 		_SetPreferredAppMode(allow ? PreferredAppMode::ForceDark : PreferredAppMode::Default);
 }
 
-void FlushMenuThemes()
+static void FlushMenuThemes()
 {
 	if (_FlushMenuThemes)
 	{
@@ -228,7 +228,7 @@ void EnableDarkScrollBarForWindowAndChildren(HWND hwnd)
 	g_darkScrollBarWindows.insert(hwnd);
 }
 
-bool IsWindowOrParentUsingDarkScrollBar(HWND hwnd)
+static bool IsWindowOrParentUsingDarkScrollBar(HWND hwnd)
 {
 	HWND hwndRoot = GetAncestor(hwnd, GA_ROOT);
 
@@ -243,7 +243,7 @@ bool IsWindowOrParentUsingDarkScrollBar(HWND hwnd)
 	return false;
 }
 
-void FixDarkScrollBar()
+static void FixDarkScrollBar()
 {
 	HMODULE hComctl = LoadLibraryEx(L"comctl32.dll", nullptr, LOAD_LIBRARY_SEARCH_SYSTEM32);
 	if (hComctl)
@@ -273,7 +273,7 @@ void FixDarkScrollBar()
 	}
 }
 
-constexpr bool CheckBuildNumber(DWORD buildNumber)
+static constexpr bool CheckBuildNumber(DWORD buildNumber)
 {
 	return (buildNumber == 17763 || // 1809
 		buildNumber == 18362 || // 1903
@@ -416,7 +416,7 @@ void SetMySysColor(int nIndex, COLORREF clr)
 	}
 }
 
-DWORD WINAPI MyGetSysColor(int nIndex)
+static DWORD WINAPI MyGetSysColor(int nIndex)
 {
 	if( !(g_darkModeEnabled))
 			return GetSysColor(nIndex);
diff --git a/DarkMode/DarkModeSubclass.cpp b/DarkMode/DarkModeSubclass.cpp
index ddbe6ee9f..285a7cda8 100644
--- a/DarkMode/DarkModeSubclass.cpp
+++ b/DarkMode/DarkModeSubclass.cpp
@@ -68,6 +68,8 @@
 #pragma comment(lib, "Gdi32.lib")
 #endif
 
+static constexpr const wchar_t* g_iniName = L"7zDark";
+
 static constexpr COLORREF HEXRGB(DWORD rrggbb) {
 	// from 0xRRGGBB like natural #RRGGBB
 	// to the little-endian 0xBBGGRR
@@ -573,9 +575,9 @@ namespace DarkMode
 	static auto g_mica = DWMSBT_AUTO;
 	static bool g_micaExtend = false;
 
-	void initOptions()
+	static void initOptions()
 	{
-		std::wstring iniPath = getIniPath(L"7zDark");
+		std::wstring iniPath = getIniPath(g_iniName);
 		if (fileExists(iniPath))
 		{
 			switch (::GetPrivateProfileInt(L"main", L"mode", 1, iniPath.c_str()))
@@ -1890,7 +1892,7 @@ namespace DarkMode
 		~ComboboxData() = default;
 	};
 
-	void paintCombobox(HWND hWnd, HDC hdc, ComboboxData& comboboxData)
+	static void paintCombobox(HWND hWnd, HDC hdc, ComboboxData& comboboxData)
 	{
 		auto& themeData = comboboxData._themeData;
 		const auto& hTheme = themeData._hTheme;
@@ -2172,6 +2174,24 @@ namespace DarkMode
 				break;
 			}
 
+			case WM_CTLCOLOREDIT:
+			{
+				if (DarkMode::isEnabled())
+				{
+					return DarkMode::onCtlColorCtrl(reinterpret_cast<HDC>(wParam));
+				}
+				break;
+			}
+
+			case WM_CTLCOLORLISTBOX:
+			{
+				if (DarkMode::isEnabled())
+				{
+					return DarkMode::onCtlColorListbox(wParam, lParam);
+				}
+				break;
+			}
+
 			case WM_COMMAND:
 			{
 				// ComboboxEx has only one child combobox, so only control-defined notification code is checked.
@@ -2335,7 +2355,7 @@ namespace DarkMode
 		{}
 	};
 
-	void paintHeader(HWND hWnd, HDC hdc, HeaderData& headerData)
+	static void paintHeader(HWND hWnd, HDC hdc, HeaderData& headerData)
 	{
 		auto& themeData = headerData._themeData;
 		const auto& hTheme = themeData._hTheme;
@@ -2984,7 +3004,7 @@ namespace DarkMode
 
 			DWORD cchText = 0;
 			cchText = LOWORD(::SendMessage(hWnd, SB_GETTEXTLENGTH, i, 0));
-			str.resize(cchText + 1); // technically the std::wstring might not have an internal null character at the end of the buffer, so add one
+			str.resize(static_cast<size_t>(cchText) + 1); // technically the std::wstring might not have an internal null character at the end of the buffer, so add one
 			LRESULT lr = ::SendMessage(hWnd, SB_GETTEXT, i, reinterpret_cast<LPARAM>(str.data()));
 			str.resize(cchText); // remove the extra NULL character
 			bool ownerDraw = false;
